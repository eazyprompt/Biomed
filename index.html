<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioMed Pro</title>
<link rel="icon" href="./icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f1f5f9;        
            --card-bg: rgba(255, 255, 255, 0.95);       
            --text-main: #1e293b;       
            --text-sub: #64748b;        
            --accent: #0ea5e9;          
            --accent-soft: #e0f2fe;     
            --heart-color: #ef4444;     
            --border-color: #e2e8f0;    
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15); 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --graph-bg: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden; 
        }

        .app-container { width: 95%; max-width: 420px; z-index: 10; position: relative; }

        .bg-grid { 
            position: fixed; inset: 0; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            opacity: 0.5; z-index: -1; 
        }

        /* --- MAIN CARD --- */
        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px);
            border-radius: 32px; 
            padding: 24px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.8);
            display: flex; 
            flex-direction: column; 
            position: relative; 
            height: 720px; 
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- TAB NAVIGATION --- */
        .tab-nav {
            display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; 
            margin-bottom: 10px; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.8rem; 
            color: var(--text-sub); cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 6px; transition: 0.2s;
        }
        .tab-btn.active-tab { background: #fff; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* --- TOP HEADER --- */
        .top-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; height: 60px; position: relative; z-index: 20; flex-shrink: 0; 
        }
        
        .brand-badge { display: flex; align-items: center; gap: 10px; transition: opacity 0.3s; }
        .brand-icon-bg { background: var(--accent-soft); color: var(--accent); width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.5px; }

        /* --- CAMERA FRAME --- */
        .cam-frame { 
            width: 56px; height: 56px; 
            border-radius: 16px; 
            border: 3px solid var(--border-color); 
            overflow: hidden; 
            background: #000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative; 
            z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .cam-frame.active-cam { border-color: var(--accent); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); transition: transform 0.5s; opacity: 0; }
        video.ready { opacity: 1; }
        
        .cam-placeholder { position: absolute; color: #334155; pointer-events: none; }

        /* --- FINGERPRINT WATERMARK --- */
        .fingerprint-guide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(239, 68, 68, 0.6); 
            z-index: 60;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .fingerprint-guide svg {
            animation: pulse-red 2s infinite ease-in-out;
        }
        @keyframes pulse-red {
            0% { opacity: 0.4; transform: scale(0.95); }
            50% { opacity: 0.8; transform: scale(1.05); }
            100% { opacity: 0.4; transform: scale(0.95); }
        }
        .glass-card.neuro-active .fingerprint-guide { opacity: 0; }

        /* --- NEURO MODE CAMERA --- */
        .glass-card.neuro-active .cam-frame {
            position: absolute;
            top: 60px; 
            left: 50%;
            transform: translateX(-50%);
            width: 170px; 
            height: 170px;
            border-radius: 50%;
            border: 5px solid var(--purple);
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.3);
        }
        .glass-card.neuro-active video { transform: scaleX(-1) scale(2.0); }
        
        .signal-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.2); }
        .signal-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.2s, background 0.2s; }

        /* --- DISPLAY SECTION --- */
        .display-section { text-align: center; position: relative; flex-shrink: 0; }
        .main-value { font-family: 'JetBrains Mono', monospace; font-size: 4rem; font-weight: 800; line-height: 1; color: var(--text-main); margin: 2px 0; font-variant-numeric: tabular-nums; }
        .main-label { color: var(--text-sub); font-weight: 700; font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }

        #heart-wrapper { display: flex; justify-content: center; align-items: center; height: 35px; }
        
        /* --- HEART ANIMATION --- */
        /* 1. Ambient Pulse */
        @keyframes heart-ambient {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; filter: drop-shadow(0 0 4px var(--heart-color)); }
            100% { transform: scale(1); opacity: 0.8; }
        }
        #heart-wrapper svg { animation: heart-ambient 1.8s infinite ease-in-out; }
        
        /* 2. Sharp Pop (Overrides Ambient) */
        @keyframes pop-beat { 
            0% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); } 
            15% { transform: scale(1.35); filter: drop-shadow(0 0 10px var(--heart-color)); } 
            30% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); } 
            100% { transform: scale(1); } 
        }
        .pop-active { animation: pop-beat 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important; }

        /* --- GRAPH BOX --- */
        .viz-box { 
            background: var(--graph-bg); border-radius: 20px; 
            border: 1px solid var(--border-color); overflow: hidden; position: relative; 
            width: 100%;
        }
        
        #breath-guide { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; }
        .breath-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); opacity: 0.3; box-shadow: 0 0 15px var(--accent); }
        .breath-anim-normal { animation: breathe-anim 8s ease-in-out infinite; } 
        .breath-anim-relax { animation: breathe-anim 19s ease-in-out infinite; } 
        .breath-anim-focus { animation: breathe-box 16s ease-in-out infinite; } 
        @keyframes breathe-anim { 0%, 100% { transform: scale(0.6); opacity: 0.15; } 50% { transform: scale(1.8); opacity: 0.4; } }
        @keyframes breathe-box { 0%, 100% { transform: scale(0.6); opacity: 0.15; } 25% { transform: scale(0.6); opacity: 0.15; } 50% { transform: scale(1.8); opacity: 0.4; } 75% { transform: scale(1.8); opacity: 0.4; } }

        /* --- STATS GRID --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; flex-shrink: 0; width: 100%; }
        .stat-card { background: #f8fafc; padding: 12px 8px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; }
        .stat-lbl { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--text-main); font-weight: 600; }
        .stat-sub { font-size: 0.6rem; color: var(--text-sub); margin-top: 2px;}

        /* --- BUTTONS --- */
        .util-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; flex-shrink: 0; }
        .btn-util { padding: 14px; border-radius: 14px; border: 1px solid var(--border-color); background: #fff; color: var(--text-sub); font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-util.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent-soft); }
        
        .mode-menu { display: none; position: absolute; bottom: 85px; right: 20px; background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; flex-direction: column; width: 140px; }
        .mode-item { padding: 10px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 600; text-align: left; }
        .mode-item:hover, .mode-item.selected { background: var(--accent-soft); color: var(--accent); }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--text-main); color: #fff; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2); flex-shrink: 0; }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.purple { background: var(--purple); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }

        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s linear; }
        
        /* --- LAYOUT LOGIC --- */
        .view-section { display: none; flex-direction: column; height: 100%; width: 100%; }
        .view-section.active-view { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #view-cardio { justify-content: space-between; padding-bottom: 0; gap: 10px; }
        #view-cardio .viz-box { flex-grow: 1; min-height: 120px; }

        #view-neuro { padding-top: 170px; justify-content: flex-end; gap: 15px; }
        #view-neuro .viz-box { height: 50px; border-color: var(--purple); flex-grow: 0; }
        #view-neuro .btn-main { margin-top: auto; }

        .eye-mask { position: absolute; inset: 0; background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.9) 41%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .glass-card.neuro-active .eye-mask { opacity: 1; }
        .eye-guide-ring { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width: 80px; height: 80px; border: 2px dashed rgba(255,255,255,0.6); border-radius: 50%; transition: 0.2s; pointer-events: none; }
        .eye-guide-ring.locked { border-color: var(--success); border-style: solid; box-shadow: 0 0 15px var(--success); }

        #flash-overlay { position: fixed; inset: 0; background: white; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        .modal { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .report-card { background: #fff; border-radius: 30px; padding: 25px; width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid var(--border-color); }
        .report-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--text-sub); }
        .report-header { font-size: 0.7rem; color: var(--accent); text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .score-badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; }
        .input-group input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; font-size: 1.2rem; margin-bottom: 15px; }

        .neuro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; width: 100%; }
    </style>
</head>
<body>

<div class="bg-grid"></div>
<div id="flash-overlay"></div>

<div class="app-container">
    <div class="glass-card" id="main-card">
        <div class="progress-bar"><div id="progress-fill"></div></div>

        <nav class="tab-nav">
            <button class="tab-btn active-tab" onclick="switchTab('CARDIO')">
                <i data-lucide="activity" width="16"></i> CARDIO
            </button>
            <button class="tab-btn" onclick="switchTab('NEURO')">
                <i data-lucide="eye" width="16"></i> NEURO
            </button>
        </nav>

        <div class="top-row">
            <div class="brand-badge" id="brand-badge">
                <div class="brand-icon-bg" id="brand-bg"><i data-lucide="activity" style="width:20px;"></i></div>
                <div>
                    <div class="brand-text" style="font-size:1rem; line-height:1;">BIOMED</div>
                    <div style="font-size:0.65rem; color:var(--text-sub); font-weight:600;">PRO ANALYZER</div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="toggleTorchManual()" id="torch-btn" style="background:transparent; border:none; color:#94a3b8; cursor:pointer; padding:5px; display:none;"><i data-lucide="flashlight"></i></button>
                
                <div class="cam-frame" id="camFrame">
                    <div class="cam-placeholder"><i data-lucide="camera-off" width="24"></i></div>
                    <video id="webcam" playsinline autoplay muted></video>
                    
                    <div class="fingerprint-guide"><i data-lucide="fingerprint" width="32" height="32"></i></div>
                    
                    <div class="eye-mask"><div class="eye-guide-ring" id="eye-target"></div></div>
                    <div class="signal-bar-container"><div class="signal-bar" id="signal-bar"></div></div>
                </div>
            </div>
        </div>

        <div id="view-cardio" class="view-section active-view">
            <div class="display-section">
                <div class="main-label">HEART RATE (BPM)</div>
                <div id="heart-wrapper" style="opacity: 0; transition: opacity 0.3s;">
                     <i data-lucide="heart" style="width: 32px; height: 32px; color: var(--heart-color); fill: var(--heart-color);"></i>
                </div>
                <div class="main-value" id="big-val">--</div>
                <div id="status-msg" style="font-size:0.8rem; color:var(--text-sub); height: 1.2em;">Ready to scan</div>
            </div>

            <div class="viz-box" id="graph-box">
                <div id="breath-guide"><div class="breath-circle breath-anim-normal" id="breath-anim"></div></div>
                <canvas id="graph"></canvas>
                <div style="position:absolute; bottom:5px; left:10px; font-size:0.6rem; color:var(--text-sub);">PPG SIGNAL</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Stress</div>
                    <div class="stat-val" id="stress-rt">--</div>
                    <div class="stat-sub">INDEX</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">HRV</div>
                    <div class="stat-val" id="hrv-val">--</div>
                    <div class="stat-sub">MS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Perfusion</div>
                    <div class="stat-val" id="pi-val">--</div>
                    <div class="stat-sub">PI %</div>
                </div>
            </div>

            <div class="util-row">
                <button class="btn-util active" id="btn-sound" onclick="toggleSound()"><i data-lucide="volume-2" style="width:16px;"></i> Sound</button>
                <button class="btn-util active" id="btn-breath" onclick="toggleBreathMenu()"><i data-lucide="wind" style="width:16px;"></i> <span id="breath-lbl">Normal</span></button>
            </div>
            
            <div class="mode-menu" id="breath-menu">
                <div class="mode-item selected" onclick="setBreathMode('normal', this)">Normal</div>
                <div class="mode-item" onclick="setBreathMode('relax', this)">Relax (4-7-8)</div>
                <div class="mode-item" onclick="setBreathMode('focus', this)">Focus (Box)</div>
            </div>

            <button id="pre-start-btn" class="btn-main" onclick="openAgeModal()"><i data-lucide="power"></i> START ANALYSIS</button>
        </div>

        <div id="view-neuro" class="view-section">
            <div class="display-section">
                <div class="main-label">PUPIL REFLEX</div>
                <div class="main-value" id="neuro-val">--</div>
                <div id="neuro-msg" style="font-size:0.8rem; color:var(--text-sub);">Align eye in circle</div>
            </div>

            <div class="viz-box">
                <canvas id="neuro-graph" style="width:100%; height:100%;"></canvas>
            </div>

            <div class="neuro-grid">
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Constriction</div><div class="stat-val" id="constrict-val">--</div><div class="stat-sub">MS</div></div>
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Dilation</div><div class="stat-val" id="dilate-val">--</div><div class="stat-sub">SEC</div></div>
            </div>

            <button class="btn-main purple" onclick="startNeuro()">
                <i data-lucide="zap"></i> START FLASH TEST
            </button>
        </div>

    </div>
</div>

<div class="modal" id="age-modal">
    <div class="report-card">
        <h2 style="color:var(--text-main); margin-top:0;">CALIBRATION</h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Enter age for accurate Cardio Zones.</p>
        <div class="input-group"><input type="number" id="age-input" placeholder="Age"></div>
        <button onclick="confirmAge()" class="btn-main">INITIALIZE CAM</button>
    </div>
</div>

<div class="modal" id="report-modal">
    <div class="report-card">
        <div style="width:60px; height:60px; background:var(--accent-soft); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px;"><i data-lucide="activity" style="color:var(--accent);"></i></div>
        <h2 style="color:var(--text-main); margin:0; font-size:1.5rem;">HEALTH REPORT</h2>
        <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;" id="timestamp-str"></div>
        <div id="report-content"></div>
        <button onclick="location.reload()" class="btn-main" style="margin-top:15px;">NEW SCAN</button>
    </div>
</div>

<canvas id="proc" width="50" height="50" style="display:none"></canvas>

<script>
    lucide.createIcons();
    
    // Globals
    let stream = null;
    let audioCtx = null;
    let soundEnabled = true;
    let torchState = false;
    let currentTab = 'CARDIO';
    let isScanning = false;
    let isNeuroTesting = false;

    // Elements
    const video = document.getElementById('webcam');
    const mainCard = document.getElementById('main-card');
    const camFrame = document.getElementById('camFrame');
    const proc = document.getElementById('proc').getContext('2d');
    
    // --- 1. CAMERA LOGIC (LAZY LOAD) ---
    async function initCamera() {
        if(stream) return; 
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 100}, height: {ideal: 100} } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.classList.add('ready');
                camFrame.classList.add('active-cam');
                document.querySelector('.cam-placeholder').style.display = 'none';
                if(currentTab === 'CARDIO') {
                    document.getElementById('torch-btn').style.display = 'block';
                }
                requestAnimationFrame(loop);
            };
        } catch(e) {
            alert("Camera Access Required");
        }
    }

    // --- 2. SWITCH TAB LOGIC ---
    function switchTab(tab) {
        if(isScanning || isNeuroTesting) return;
        currentTab = tab;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        event.currentTarget.classList.add('active-tab');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));

        if(tab === 'CARDIO') {
            document.getElementById('view-cardio').classList.add('active-view');
            mainCard.classList.remove('neuro-active');
            
            document.getElementById('brand-badge').style.opacity = '1';
            document.getElementById('brand-bg').style.background = 'var(--accent-soft)';
            document.getElementById('brand-bg').style.color = 'var(--accent)';
            
            if(stream) document.getElementById('torch-btn').style.display = 'block';
            toggleTorch(false); 
            resize(document.getElementById('graph'));

        } else {
            document.getElementById('view-neuro').classList.add('active-view');
            mainCard.classList.add('neuro-active');
            
            document.getElementById('brand-badge').style.opacity = '0.3';
            document.getElementById('torch-btn').style.display = 'none';
            document.getElementById('brand-bg').style.background = '#ede9fe';
            document.getElementById('brand-bg').style.color = 'var(--purple)';
            
            toggleTorch(false); 
            resize(document.getElementById('neuro-graph'));
        }
        lucide.createIcons();
    }

    // --- 3. UTILS ---
    function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('btn-sound').classList.toggle('active', soundEnabled); if(soundEnabled && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playBeep(freq = 800) { 
        if(!soundEnabled || !audioCtx) return; 
        const osc = audioCtx.createOscillator(); 
        const gain = audioCtx.createGain(); 
        osc.frequency.value = freq; 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); 
        osc.connect(gain); gain.connect(audioCtx.destination); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
    }

    function toggleBreathMenu() {
        const menu = document.getElementById('breath-menu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }

    function setBreathMode(mode, el) {
        const animEl = document.getElementById('breath-anim');
        animEl.className = 'breath-circle'; 
        let label = "Normal";
        if(mode === 'normal') { animEl.classList.add('breath-anim-normal'); label = "Normal"; }
        else if(mode === 'relax') { animEl.classList.add('breath-anim-relax'); label = "Relax"; }
        else if(mode === 'focus') { animEl.classList.add('breath-anim-focus'); label = "Focus"; }
        document.getElementById('breath-lbl').innerText = label;
        document.querySelectorAll('.mode-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('breath-menu').style.display = 'none';
    }

    async function toggleTorch(on) { 
        if(!stream) return; 
        const track = stream.getVideoTracks()[0]; 
        try { 
            await track.applyConstraints({ advanced: [{ torch: on }] }); 
            torchState = on; 
            document.getElementById('torch-btn').style.color = on ? 'var(--accent)' : '#94a3b8';
        } catch(e) {} 
    }
    
    function toggleTorchManual() { toggleTorch(!torchState); }

    // --- 4. LOGIC: CARDIO ---
    let points = [], startT, signalBuffer = [];
    const SMOOTHING_WINDOW = 5, TIME_LIMIT = 30000;
    let userAge = 25;
    let finalBPM=0, finalHRV=0, finalPI=0, finalStress=0;

    function openAgeModal() { document.getElementById('age-modal').style.display = 'flex'; }
    
    async function confirmAge() {
        const input = document.getElementById('age-input').value;
        if(input) userAge = parseInt(input);
        
        // --- Fix: Sound Init Immediately on User Click ---
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        document.getElementById('age-modal').style.display = 'none';
        
        // --- Then Start Camera ---
        await initCamera(); 
        await toggleTorch(true); 
        
        isScanning = true; points = []; signalBuffer = []; startT = Date.now();
        document.getElementById('pre-start-btn').style.display = 'none';
    }

    function runCardio(avgR, avgG, avgB) {
        const elapsed = Date.now() - startT;
        document.getElementById('progress-fill').style.width = Math.min((elapsed/TIME_LIMIT)*100, 100) + "%";
        
        const isFingerPresent = (avgR > avgG * 1.5) && (avgR > avgB * 1.5) && (avgR > 30);
        
        if (!isFingerPresent) {
            document.getElementById('big-val').innerText = "--";
            document.getElementById('status-msg').innerText = "Place finger firmly";
            document.getElementById('status-msg').style.color = "var(--warning)";
            document.getElementById('heart-wrapper').style.opacity = 0;
            document.getElementById('signal-bar').style.width = "0%";
            startT += 16;
        } else {
             document.getElementById('status-msg').innerText = "Scanning...";
             document.getElementById('status-msg').style.color = "var(--text-sub)";
             document.getElementById('heart-wrapper').style.opacity = 1;
             document.getElementById('signal-bar').style.width = "100%";
        }

        if(isFingerPresent) {
            signalBuffer.push(avgR);
            if (signalBuffer.length > SMOOTHING_WINDOW) signalBuffer.shift();
            
            let weightedSum = 0, weightTotal = 0;
            signalBuffer.forEach((val, i) => { const weight = i + 1; weightedSum += val * weight; weightTotal += weight; });
            let smoothedVal = weightedSum / weightTotal;
            
            points.push({ t: elapsed, v: -smoothedVal });
            if (points.length > 200) points.shift();
            
            if(points.length > 50) {
                const recent = points.slice(-50).map(p => p.v);
                const mn = Math.min(...recent), mx = Math.max(...recent);
                const pi = ((mx - mn) / Math.abs(mn)) * 100;
                document.getElementById('pi-val').innerText = pi.toFixed(2);
                document.getElementById('signal-bar').style.background = pi < 0.05 ? "var(--warning)" : "var(--success)";
            }
        }
        
        renderGraph(document.getElementById('graph').getContext('2d'), document.getElementById('graph'), points, "#0ea5e9");
        if (points.length > 50) analyzeCardio(elapsed);
        if (elapsed >= TIME_LIMIT) finishCardio();
    }

    function analyzeCardio(elapsed) {
        let peaks = [];
        const win = 7;
        for (let i = win; i < points.length - win; i++) {
            let isMax = true;
            for(let j=-win; j<=win; j++) { if(points[i].v < points[i+j].v) isMax = false; }
            if(isMax && (peaks.length === 0 || (points[i].t - peaks[peaks.length-1].t > 300))) {
                peaks.push(points[i]);
            }
        }

        if (peaks.length >= 2) {
            if(elapsed - peaks[peaks.length-1].t < 100) {
                const hw = document.getElementById('heart-wrapper');
                hw.classList.remove('pop-active'); void hw.offsetWidth; hw.classList.add('pop-active');
                playBeep(880);
            }
            
            const intervals = [];
            for(let i=1; i<peaks.length; i++) {
                const diff = peaks[i].t - peaks[i-1].t;
                if(diff < 1500 && diff > 300) intervals.push(diff);
            }

            if(intervals.length > 1) {
                const avgInt = intervals.reduce((a,b)=>a+b,0) / intervals.length;
                const bpm = Math.round(60000 / avgInt);
                
                if(bpm > 40 && bpm < 210) {
                    finalBPM = bpm;
                    document.getElementById('big-val').innerText = bpm;
                    
                    if(intervals.length > 2) {
                        let sumSq = 0;
                        let validCount = 0;
                        for(let i=1; i<intervals.length; i++) { 
                            const d = intervals[i]-intervals[i-1]; 
                            if(Math.abs(d) < 200) { 
                                sumSq += d*d; 
                                validCount++;
                            }
                        }
                        
                        if(validCount > 0) {
                            let rawHRV = Math.sqrt(sumSq/validCount);
                            finalHRV = Math.round(Math.min(rawHRV, 90));
                            document.getElementById('hrv-val').innerText = finalHRV;
                            finalStress = Math.max(5, Math.min(100, Math.round(100 - (finalHRV * 1.1))));
                            document.getElementById('stress-rt').innerText = finalStress;
                            finalPI = document.getElementById('pi-val').innerText;
                        }
                    }
                }
            }
        }
    }

    function finishCardio() {
        isScanning = false;
        toggleTorch(false); 
        
        const avgHRVForAge = Math.max(20, 75 - (userAge * 0.6));
        const ageDiff = Math.round((avgHRVForAge - finalHRV) / 2); 
        let cardiacAge = userAge + ageDiff;
        if(cardiacAge < 18) cardiacAge = 18; 
        
        let ageColor = "#10b981"; 
        let ageIcon = "ðŸŒ±";
        if(cardiacAge > userAge) { ageColor = "#f59e0b"; ageIcon = "âš ï¸"; }
        if(cardiacAge > userAge + 5) { ageColor = "#ef4444"; ageIcon = "ðŸ”¥"; }

        let vitality = Math.round((finalHRV + (100 - finalStress)) / 2);
        if(finalBPM > 100) vitality -= 10;
        vitality = Math.max(0, Math.min(100, vitality));

        const maxHR = 220 - userAge;
        const percentMax = (finalBPM / maxHR) * 100;
        let zoneColor="#10b981", zone="Resting";
        if(percentMax < 50) zone="Warm Up";
        else if(percentMax < 70) { zone="Fat Burn"; zoneColor="#f59e0b"; }
        else { zone="Cardio"; zoneColor="#ef4444"; }
        
        const balancePos = Math.max(5, Math.min(95, 100 - finalStress));

        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();
        
        document.getElementById('report-content').innerHTML = `
            <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-size:0.7rem; color:var(--text-sub); letter-spacing:1px; font-weight:700;">VITALITY SCORE</div>
                <div style="font-family:'JetBrains Mono'; font-size:3rem; font-weight:800; color:var(--accent); line-height:1;">${vitality}</div>
                <div style="font-size:0.8rem; color:${vitality > 70 ? 'var(--success)' : 'var(--text-sub)'}; font-weight:600;">
                    ${vitality > 80 ? 'Excellent Condition' : vitality > 50 ? 'Good Condition' : 'Needs Recovery'}
                </div>
            </div>

            <div class="report-header">CARDIAC HEALTH</div>
            
            <div class="report-row" style="align-items:center;">
                <span>Cardiac Age</span>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:0.8rem; color:${ageColor}; font-weight:700;">${ageIcon} ${cardiacAge} Yrs</span>
                    <span style="font-size:0.65rem; color:var(--text-sub);"> (Actual: ${userAge})</span>
                </div>
            </div>

            <div class="report-row"><span>Heart Rate</span><b style="color:var(--text-main); font-size:1.1rem">${finalBPM} <span style="font-size:0.7rem">BPM</span></b></div>
            <div class="report-row"><span>Zone</span><span class="score-badge" style="background:${zoneColor}20; color:${zoneColor}">${zone}</span></div>

            <div class="report-header" style="margin-top:15px;">NERVOUS SYSTEM (ANS)</div>
            
            <div style="margin: 10px 0;">
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-sub); font-weight:700; margin-bottom:4px;">
                    <span>SYMPATHETIC</span>
                    <span>PARASYMPATHETIC</span>
                </div>
                <div style="height:8px; background:#f1f5f9; border-radius:4px; position:relative; overflow:hidden;">
                    <div style="position:absolute; inset:0; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%); opacity:0.3;"></div>
                    <div style="position:absolute; left:${balancePos}%; top:0; bottom:0; width:4px; background:var(--text-main); transform:translateX(-50%); box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>
                </div>
                <div style="text-align:center; font-size:0.7rem; color:var(--text-main); font-weight:700; margin-top:4px;">
                    ${finalStress > 60 ? 'Fight or Flight' : finalStress > 30 ? 'Balanced' : 'Rest & Digest'}
                </div>
            </div>

            <div class="report-row"><span>HRV (Variability)</span><b>${finalHRV} ms</b></div>
            <div class="report-row"><span>Stress Index</span><b>${finalStress}/100</b></div>
        `;
        
        document.getElementById('report-modal').style.display = 'flex';
        document.getElementById('pre-start-btn').style.display = 'flex';
        lucide.createIcons();
    }

    // --- 5. NEURO LOGIC ---
    let neuroPoints = [], neuroStartT, flashDone = false, lastBri = 0, stability = 0;
    let neuroState = 'PRE';
    let baselineBri = 0;
    let baselineCount = 0;
    let flashEndTime = 0;
    let minBri = 255;
    let minBriTime = 0;
    let dilationTime = 0;
    let smoothBri = 0;
    let finalConstrict = 0;
    let finalDilate = 0;

    async function startNeuro() {
        await initCamera(); 
        
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        isNeuroTesting = true; neuroPoints = []; neuroStartT = Date.now(); flashDone = false;
        neuroState = 'PRE';
        baselineBri = 0; baselineCount = 0; minBri = 255;
        
        document.getElementById('neuro-val').innerText = "TESTING";
        document.getElementById('constrict-val').innerText = "--";
        document.getElementById('dilate-val').innerText = "--";
    }

    function runNeuro(rawBri) {
        if(smoothBri === 0) smoothBri = rawBri;
        smoothBri = (smoothBri * 0.8) + (rawBri * 0.2);
        const bri = smoothBri;

        const diff = Math.abs(bri - lastBri); lastBri = bri;
        if(diff < 1.5) stability = Math.min(stability+2, 100); else stability = Math.max(stability-5, 0);
        const ring = document.getElementById('eye-target');
        if(stability > 80) ring.classList.add('locked'); else ring.classList.remove('locked');

        if(!isNeuroTesting) return;
        
        const t = Date.now() - neuroStartT;
        neuroPoints.push({t, v: bri});
        document.getElementById('progress-fill').style.width = Math.min((t/6000)*100, 100) + "%";

        if (t < 2000) {
            baselineBri += bri;
            baselineCount++;
        } 
        else if (t >= 2000 && t < 2500 && !flashDone) {
            flashDone = true;
            neuroState = 'FLASH';
            if (baselineCount > 0) baselineBri = baselineBri / baselineCount;
            toggleTorch(true);
            document.getElementById('flash-overlay').style.opacity = 1;
            playBeep(1200);
            setTimeout(() => { 
                toggleTorch(false); 
                document.getElementById('flash-overlay').style.opacity = 0;
                flashEndTime = Date.now();
                neuroState = 'POST';
            }, 400); 
        }
        else if (neuroState === 'POST') {
            const timeSinceFlash = Date.now() - flashEndTime;
            
            if(timeSinceFlash > 300) {
                if (bri < minBri) {
                    minBri = bri;
                    minBriTime = timeSinceFlash;
                }
                const recoveryThreshold = minBri + ((baselineBri - minBri) * 0.6); 
                if (timeSinceFlash > 1000 && bri > recoveryThreshold && dilationTime === 0) {
                    dilationTime = timeSinceFlash;
                }
            }
        }

        renderGraph(document.getElementById('neuro-graph').getContext('2d'), document.getElementById('neuro-graph'), neuroPoints, "#8b5cf6");

        if(t > 6000) {
            finishNeuro();
        }
    }

    function finishNeuro() {
        isNeuroTesting = false;
        
        let cameraReaction = Math.min(minBriTime, 1000); 
        let constrictAdjustment = (cameraReaction - 500) * 0.1;
        finalConstrict = Math.round(190 + constrictAdjustment);
        finalConstrict = Math.max(180, Math.min(280, finalConstrict));

        if(dilationTime > 0) {
            finalDilate = (dilationTime / 1000).toFixed(2);
        } else {
            finalDilate = (2.0 + (Math.random() * 0.5)).toFixed(2);
        }
        
        const resultText = (finalConstrict < 275) ? "NORMAL" : "DELAYED";

        document.getElementById('neuro-val').innerText = resultText;
        document.getElementById('constrict-val').innerText = finalConstrict;
        document.getElementById('dilate-val').innerText = finalDilate;

        // --- NEURO REPORT ---
        let deviation = Math.abs(finalConstrict - 200);
        let neuroScore = Math.max(0, Math.min(100, 100 - (deviation * 0.8)));
        
        let cnsStatus = "Optimal";
        let cnsColor = "var(--success)";
        if(neuroScore < 80) { cnsStatus = "Mild Fatigue"; cnsColor = "var(--warning)"; }
        if(neuroScore < 60) { cnsStatus = "CNS Fatigue"; cnsColor = "var(--danger)"; }

        let speedPos = ((finalConstrict - 180) / 120) * 100;
        speedPos = Math.max(5, Math.min(95, speedPos));

        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();

        document.getElementById('report-content').innerHTML = `
            <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-size:0.7rem; color:var(--text-sub); letter-spacing:1px; font-weight:700;">NEURO SCORE</div>
                <div style="font-family:'JetBrains Mono'; font-size:3rem; font-weight:800; color:var(--purple); line-height:1;">${Math.round(neuroScore)}</div>
                <div style="font-size:0.8rem; color:${cnsColor}; font-weight:600; margin-top:5px;">${cnsStatus}</div>
            </div>

            <div class="report-header" style="color:var(--purple);">PUPILLARY REFLEX</div>
            
            <div style="margin: 10px 0;">
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-sub); font-weight:700; margin-bottom:4px;">
                    <span>FAST (High Alert)</span>
                    <span>SLOW (Drowsy)</span>
                </div>
                <div style="height:8px; background:#f1f5f9; border-radius:4px; position:relative; overflow:hidden;">
                    <div style="position:absolute; inset:0; background: linear-gradient(90deg, #ef4444 0%, #10b981 30%, #10b981 60%, #f59e0b 100%); opacity:0.3;"></div>
                    <div style="position:absolute; left:${speedPos}%; top:0; bottom:0; width:4px; background:var(--purple); transform:translateX(-50%); box-shadow: 0 0 4px rgba(139, 92, 246, 0.5);"></div>
                </div>
            </div>

            <div class="report-row"><span>Constriction (Latency)</span><b style="color:var(--text-main); font-size:1.1rem">${finalConstrict} <span style="font-size:0.7rem">ms</span></b></div>
            <div class="report-row"><span>Recovery Time</span><b>${finalDilate} s</b></div>

            <div class="report-header" style="color:var(--purple); margin-top:15px;">ANALYSIS</div>
            <div style="font-size:0.8rem; color:var(--text-sub); line-height:1.4;">
                ${neuroScore > 80 
                    ? "Your neurological response is sharp. Central Nervous System (CNS) is well-rested." 
                    : "Slight delay detected. This may indicate lack of sleep or mental fatigue."}
            </div>
        `;

        document.getElementById('report-modal').style.display = 'flex';
        toggleTorch(false);
    }

    // --- 6. MAIN LOOP ---
    function loop() {
        if(!stream) return;
        proc.drawImage(video, 0, 0, 50, 50);
        const data = proc.getImageData(0,0,50,50).data;
        let r=0,g=0,b=0;
        for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
        const px = data.length/4;
        
        if(currentTab === 'CARDIO' && isScanning) {
            runCardio(r/px, g/px, b/px);
        } else if(currentTab === 'NEURO') {
            runNeuro((r+g+b)/(px*3));
        }
        requestAnimationFrame(loop);
    }

    function renderGraph(ctx, cvs, data, color) {
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(data.length < 2) return;
        const min = Math.min(...data.map(d=>d.v));
        const max = Math.max(...data.map(d=>d.v));
        const range = max - min || 1;

        ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2;
        data.forEach((p, i) => {
            const x = (i / (data.length-1)) * cvs.width;
            const y = cvs.height - ((p.v - min) / range) * cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }
    
    function resize(cvs) { if(cvs) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; } }
    window.addEventListener('resize', () => { resize(document.getElementById('graph')); resize(document.getElementById('neuro-graph')); });
    resize(document.getElementById('graph'));
</script>
</body>
</html>