<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioMed Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22❤️</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --bg-color: #f1f5f9;      
            --card-bg: rgba(255, 255, 255, 0.9);        
            --text-main: #1e293b;     
            --text-sub: #64748b;      
            --accent: #0ea5e9;        
            --accent-soft: #e0f2fe;   
            --heart-color: #ef4444;   
            --border-color: #e2e8f0;  
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1); 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            /* Graph Theme Colors */
            --graph-bg: #f8fafc;
            --graph-grid: #e2e8f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden; 
        }

        .app-container { width: 95%; max-width: 420px; z-index: 10; position: relative; }

        .bg-grid { 
            position: fixed; inset: 0; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            opacity: 0.5;
            z-index: -1; 
        }

        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(10px);
            border-radius: 32px; 
            padding: 24px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.8);
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            position: relative; 
        }
        
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .brand-badge { display: flex; align-items: center; gap: 10px; }
        .brand-icon-bg { background: var(--accent-soft); color: var(--accent); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.2rem; color: var(--text-main); letter-spacing: -0.5px; }

        .cam-frame { width: 56px; height: 56px; border-radius: 16px; border: 3px solid var(--border-color); overflow: hidden; background: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s; position: relative; }
        .cam-frame.active-cam { border-color: var(--accent); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* Mirror effect */ }
        
        /* Signal Quality Bar */
        .signal-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.2); }
        .signal-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.2s, background 0.2s; }

        .display-section { text-align: center; position: relative; margin: 5px 0; }
        .main-value { font-family: 'JetBrains Mono', monospace; font-size: 4.5rem; font-weight: 800; line-height: 1; color: var(--text-main); margin: 5px 0; font-variant-numeric: tabular-nums; }
        .main-label { color: var(--text-sub); font-weight: 700; font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; }

        #heart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
            height: 40px;
        }
        
        @keyframes pop-beat {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); }
            15% { transform: scale(1.3); filter: drop-shadow(0 0 10px var(--heart-color)); }
            30% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); }
            100% { transform: scale(1); }
        }
        .pop-active { animation: pop-beat 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Graph Box Styling */
        .viz-box { 
            height: 140px; 
            background: var(--graph-bg); 
            border-radius: 20px; 
            border: 1px solid var(--border-color); 
            overflow: hidden; 
            position: relative; 
        }
        
        /* Breath Guide Animations */
        #breath-guide { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; }
        .breath-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); opacity: 0.3; box-shadow: 0 0 15px var(--accent); }
        
        .breath-anim-normal { animation: breathe-anim 8s ease-in-out infinite; } /* ~7.5 breaths/min */
        .breath-anim-relax { animation: breathe-anim 19s ease-in-out infinite; } /* 4-7-8 method */
        .breath-anim-focus { animation: breathe-box 16s ease-in-out infinite; } /* Box breathing 4-4-4-4 */

        @keyframes breathe-anim { 
            0%, 100% { transform: scale(0.6); opacity: 0.15; } 
            50% { transform: scale(1.8); opacity: 0.4; } 
        }
        @keyframes breathe-box {
            0%, 100% { transform: scale(0.6); opacity: 0.15; } /* Exhale */
            25% { transform: scale(0.6); opacity: 0.15; } /* Hold */
            50% { transform: scale(1.8); opacity: 0.4; } /* Inhale */
            75% { transform: scale(1.8); opacity: 0.4; } /* Hold */
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .stat-card { background: #f8fafc; padding: 12px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; }
        .stat-lbl { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--text-main); font-weight: 600; }
        .stat-sub { font-size: 0.6rem; color: var(--text-sub); margin-top: 2px;}

        .util-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .btn-util { padding: 12px; border-radius: 14px; border: 1px solid var(--border-color); background: #fff; color: var(--text-sub); font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-util.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent-soft); }
        
        /* Mode Menu */
        .mode-menu { display: none; position: absolute; bottom: 60px; right: 20px; background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; flex-direction: column; width: 140px; }
        .mode-item { padding: 10px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 600; text-align: left; }
        .mode-item:hover, .mode-item.selected { background: var(--accent-soft); color: var(--accent); }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--text-main); color: #fff; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 5px; box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2); }
        .btn-main:active { transform: scale(0.98); }

        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s linear; }
        
        #overlay, .modal { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        #overlay-text { font-family: 'Outfit'; margin-top: 15px; font-size: 1rem; font-weight: 600; color: var(--text-main); }
        #overlay-icon { color: var(--accent); }

        .report-card { background: #fff; border-radius: 30px; padding: 25px; width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid var(--border-color); max-height: 85vh; overflow-y: auto; }
        .report-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--text-sub); align-items: center; }
        .report-header { font-size: 0.7rem; color: var(--accent); text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .score-badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; }
        
        /* Mood Bar */
        .mood-scale { height: 6px; width: 100%; background: #e2e8f0; border-radius: 3px; margin-top: 5px; position: relative; overflow: hidden; }
        .mood-fill { height: 100%; border-radius: 3px; transition: width 1s ease-out; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        
        .input-group { margin-bottom: 20px; width: 100%; }
        .input-group input { width: 100%; background: #f1f5f9; border: 1px solid var(--border-color); color: var(--text-main); padding: 15px; border-radius: 15px; font-family: 'JetBrains Mono'; font-size: 1.2rem; text-align: center; outline: none; }
        .input-group input:focus { border-color: var(--accent); background: #fff; }
    </style>
</head>
<body>

<div class="bg-grid"></div>

<div class="app-container">
    <div class="glass-card">
        <div class="progress-bar"><div id="progress-fill"></div></div>

        <div class="top-row">
            <div class="brand-badge">
                <div class="brand-icon-bg"><i data-lucide="activity" style="width:20px;"></i></div>
                <div>
                    <div class="brand-text" style="font-size:1rem; line-height:1;">BIOMED</div>
                    <div style="font-size:0.65rem; color:var(--text-sub); font-weight:600;">PRO ANALYZER</div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="toggleTorch()" id="torch-btn" style="background:transparent; border:none; color:#94a3b8; cursor:pointer; padding:5px;"><i data-lucide="flashlight"></i></button>
                <div class="cam-frame" id="camFrame">
                    <video id="webcam" playsinline autoplay muted></video>
                    <div class="signal-bar-container"><div class="signal-bar" id="signal-bar"></div></div>
                </div>
            </div>
        </div>

        <div class="display-section">
            <div class="main-label">HEART RATE (BPM)</div>
            <div id="heart-wrapper" style="opacity: 0; transition: opacity 0.3s;">
                 <i data-lucide="heart" style="width: 35px; height: 35px; color: var(--heart-color); fill: var(--heart-color);"></i>
            </div>
            <div class="main-value" id="big-val">--</div>
            <div id="status-msg" style="font-size:0.8rem; color:var(--text-sub); height: 1.2em;">Ready to scan</div>
        </div>

        <div class="viz-box" id="graph-box">
            <div id="breath-guide"><div class="breath-circle breath-anim-normal" id="breath-anim"></div></div>
            <canvas id="graph"></canvas>
            <div style="position:absolute; bottom:5px; left:10px; font-size:0.6rem; color:var(--text-sub);">PPG SIGNAL</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-lbl">Stress</div>
                <div class="stat-val" id="stress-rt">--</div>
                <div class="stat-sub">INDEX</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl">HRV</div>
                <div class="stat-val" id="hrv-val">--</div>
                <div class="stat-sub">MS</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl">Perfusion</div>
                <div class="stat-val" id="pi-val">--</div>
                <div class="stat-sub">PI %</div>
            </div>
        </div>

        <div class="util-row">
            <button class="btn-util active" id="btn-sound" onclick="toggleSound()"><i data-lucide="volume-2" style="width:16px;"></i> Sound</button>
            <button class="btn-util active" id="btn-breath" onclick="toggleBreathMenu()"><i data-lucide="wind" style="width:16px;"></i> <span id="breath-lbl">Normal</span></button>
        </div>
        
        <div class="mode-menu" id="breath-menu">
            <div class="mode-item selected" onclick="setBreathMode('normal', this)">Normal</div>
            <div class="mode-item" onclick="setBreathMode('relax', this)">Relax (4-7-8)</div>
            <div class="mode-item" onclick="setBreathMode('focus', this)">Focus (Box)</div>
        </div>

        <button id="pre-start-btn" class="btn-main" onclick="openAgeModal()"><i data-lucide="power"></i> START ANALYSIS</button>
    </div>
</div>

<div class="modal" id="age-modal" style="display:none;">
    <div class="report-card">
        <h2 style="color:var(--text-main); margin-top:0;">CALIBRATION</h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Enter age for accurate Cardio Zones.</p>
        <div class="input-group"><input type="number" id="age-input" placeholder="Age (e.g. 25)" inputmode="numeric" value="25"></div>
        <button onclick="confirmAge()" class="btn-main">INITIALIZE CAM</button>
    </div>
</div>

<div id="overlay"><div id="overlay-icon"></div><div id="overlay-text"></div></div>

<div class="modal" id="report-modal">
    <div class="report-card">
        <div style="width:60px; height:60px; background:var(--accent-soft); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px;"><i data-lucide="activity" style="width:30px; height:30px; color:var(--accent);"></i></div>
        <h2 style="color:var(--text-main); margin:0; font-size:1.5rem;">HEALTH REPORT</h2>
        <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;" id="timestamp-str"></div>
        
        <div id="report-content"></div>
        
        <button onclick="location.reload()" class="btn-main" style="background:var(--text-main); margin-top:15px;">NEW SCAN</button>
    </div>
</div>

<canvas id="proc" width="50" height="50" style="display:none"></canvas>

<script>
    lucide.createIcons();

    let isScanning = false, stream = null, points = [], startT;
    let finalBPM = 0, finalHRV = 0, finalPI = 0, finalStress = 0;
    let userAge = 25;
    let rhythmStatus = "NORMAL", vascularIndex = "NORMAL", autonomicBalance = "BALANCED", cardioZone = "RESTING";
    let signalBuffer = []; 
    const SMOOTHING_WINDOW = 5, TIME_LIMIT = 30000; 
    
    const canvas = document.getElementById('graph'), ctx = canvas.getContext('2d'), video = document.getElementById('webcam');
    const camFrame = document.getElementById('camFrame');
    const heartWrapper = document.getElementById('heart-wrapper');
    const signalBar = document.getElementById('signal-bar');

    let audioCtx = null, soundEnabled = true, breathMode = 'normal';
    let torchState = false;

    function openAgeModal() { document.getElementById('age-modal').style.display = 'flex'; document.getElementById('age-input').focus(); }
    
    function confirmAge() {
        const input = document.getElementById('age-input').value;
        if(input && input > 5 && input < 100) userAge = parseInt(input);
        document.getElementById('age-modal').style.display = 'none';
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
        startCamera();
    }

    // --- Utilities ---
    function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('btn-sound').classList.toggle('active', soundEnabled); if(soundEnabled && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function playBeep(freq = 800) { 
        if(!soundEnabled || !audioCtx) return; 
        const osc = audioCtx.createOscillator(); 
        const gain = audioCtx.createGain(); 
        osc.frequency.value = freq; 
        osc.type = 'sine'; 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); 
        osc.connect(gain); 
        gain.connect(audioCtx.destination); 
        osc.start(); 
        osc.stop(audioCtx.currentTime + 0.1); 
    }

    function toggleBreathMenu() {
        const menu = document.getElementById('breath-menu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }

    function setBreathMode(mode, el) {
        breathMode = mode;
        const animEl = document.getElementById('breath-anim');
        animEl.className = 'breath-circle'; // reset
        
        let label = "Normal";
        if(mode === 'normal') { animEl.classList.add('breath-anim-normal'); label = "Normal"; }
        else if(mode === 'relax') { animEl.classList.add('breath-anim-relax'); label = "Relax"; }
        else if(mode === 'focus') { animEl.classList.add('breath-anim-focus'); label = "Focus"; }
        
        document.getElementById('breath-lbl').innerText = label;
        
        // Update selection UI
        document.querySelectorAll('.mode-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('breath-menu').style.display = 'none';
    }

    async function toggleTorch() { 
        if(!stream) return; 
        torchState = !torchState; 
        const track = stream.getVideoTracks()[0]; 
        try { 
            await track.applyConstraints({ advanced: [{ torch: torchState }] }); 
            document.getElementById('torch-btn').style.color = torchState ? 'var(--accent)' : '#94a3b8'; 
        } catch(e) {} 
    }

    function showOverlay(text, iconName, isSpinning = false) { 
        const overlay = document.getElementById('overlay'); 
        overlay.style.display = 'flex'; 
        document.getElementById('overlay-text').innerText = text; 
        document.getElementById('overlay-icon').innerHTML = `<i data-lucide="${iconName}" class="${isSpinning ? 'spinning' : ''}"></i>`; 
        lucide.createIcons(); 
    }

    // --- Core Camera Logic ---
    async function startCamera() {
        try {
            showOverlay("Starting Sensors...", "loader-2", true);
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 100}, height: {ideal: 100} } 
            });
            video.srcObject = stream;
            
            // Try enabling Flash
            const track = stream.getVideoTracks()[0];
            try { 
                const caps = track.getCapabilities(); 
                if(caps.torch) { 
                    await track.applyConstraints({ advanced: [{ torch: true }] }); 
                    torchState = true; 
                    document.getElementById('torch-btn').style.color = 'var(--accent)'; 
                } 
            } catch(e){}
            
            showOverlay("Calibrating Light...", "sun", true);
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                isScanning = true; points = []; signalBuffer = []; startT = Date.now();
                document.getElementById('pre-start-btn').style.display = 'none';
                camFrame.classList.add('active-cam');
                requestAnimationFrame(loop);
            }, 2000);
        } catch(e) { showOverlay("Camera Access Denied", "alert-triangle"); }
    }

    // --- Signal Processing Loop ---
    function loop() {
        if (!isScanning) return;
        const elapsed = Date.now() - startT;
        document.getElementById('progress-fill').style.width = Math.min((elapsed/TIME_LIMIT)*100, 100) + "%";
        
        // 1. Process Frame
        const pCanvas = document.getElementById('proc'), pCtx = pCanvas.getContext('2d');
        pCtx.drawImage(video, 0, 0, 50, 50);
        const data = pCtx.getImageData(0,0,50,50).data;
        
        let rTotal = 0, gTotal = 0, bTotal = 0;
        for(let i=0; i<data.length; i+=4) { rTotal += data[i]; gTotal += data[i+1]; bTotal += data[i+2]; }
        const pixels = data.length / 4;
        const avgR = rTotal / pixels;
        const avgG = gTotal / pixels; 
        const avgB = bTotal / pixels;
        
        // 2. Finger Detection logic (Red dominance)
        const isFingerPresent = (avgR > avgG * 1.5) && (avgR > avgB * 1.5) && (avgR > 30);
        
        if (!isFingerPresent) {
            document.getElementById('big-val').innerText = "--";
            document.getElementById('status-msg').innerText = "Place finger firmly on camera";
            document.getElementById('status-msg').style.color = "var(--warning)";
            document.getElementById('graph-box').style.opacity = 0.5;
            heartWrapper.style.opacity = 0;
            signalBar.style.width = "0%";
            // Pause timer effectively by adjusting startT
            startT += 16; 
        } else {
             document.getElementById('status-msg').innerText = "Scanning...";
             document.getElementById('status-msg').style.color = "var(--text-sub)";
             document.getElementById('graph-box').style.opacity = 1;
             heartWrapper.style.opacity = 1;
             
             // Signal Quality (Amplitude stability check could go here, simplified for UI)
             signalBar.style.width = "100%";
        }

        // 3. Signal Smoothing
        if(isFingerPresent) {
            let rawVal = avgR;
            signalBuffer.push(rawVal);
            if (signalBuffer.length > SMOOTHING_WINDOW) signalBuffer.shift();
            
            // Weighted moving average
            let weightedSum = 0, weightTotal = 0;
            signalBuffer.forEach((val, i) => { const weight = i + 1; weightedSum += val * weight; weightTotal += weight; });
            let smoothedVal = weightedSum / weightTotal;
            
            // Invert signal for display (blood absorbs light)
            points.push({ t: elapsed, v: -smoothedVal });
            if (points.length > 200) points.shift();
            
            // Perfusion Index estimate (AC/DC component approx)
            if(points.length > 50) {
                const recent = points.slice(-50).map(p => p.v);
                const mn = Math.min(...recent);
                const mx = Math.max(...recent);
                const pi = ((mx - mn) / Math.abs(mn)) * 100; // Rough PI%
                document.getElementById('pi-val').innerText = pi.toFixed(2);
                
                // Noise detection
                if(pi < 0.05) {
                    document.getElementById('status-msg').innerText = "Signal Weak - Press Harder";
                    signalBar.style.background = "var(--warning)";
                } else {
                    signalBar.style.background = "var(--success)";
                }
            }
        }
        
        renderGraph();
        if (points.length > 50) analyze(elapsed);
        
        if (elapsed < TIME_LIMIT) {
            requestAnimationFrame(loop);
        } else {
            finishScan();
        }
    }

    function renderGraph() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const padding = { top: 20, right: 0, bottom: 20, left: 0 };
        const w = canvas.width;
        const h = canvas.height - padding.top - padding.bottom;
        
        if (points.length < 5) return;
        
        // Auto-scale
        const vals = points.map(p => p.v);
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        const range = max - min || 1;

        ctx.beginPath();
        ctx.strokeStyle = "#0ea5e9";
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        
        const step = w / (points.length - 1);
        
        points.forEach((p, i) => { 
            const y = padding.top + h - ((p.v - min)/range * h);
            const x = i * step;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
        });
        ctx.stroke();
    }

    function triggerVisualBeat() {
        camFrame.classList.remove('beating');
        void camFrame.offsetWidth;
        camFrame.classList.add('beating');
        
        heartWrapper.classList.remove('pop-active');
        void heartWrapper.offsetWidth; 
        heartWrapper.classList.add('pop-active');

        playBeep(880); 
    }

    function analyze(elapsed) {
        // Peak Detection
        let peaks = [];
        // Local maxima window
        const win = 7;
        for (let i = win; i < points.length - win; i++) {
            let isMax = true;
            for(let j=-win; j<=win; j++) { if(points[i].v < points[i+j].v) isMax = false; }
            
            // Debounce peaks (min 300ms between beats)
            if(isMax) {
                if(peaks.length === 0 || (points[i].t - peaks[peaks.length-1].t > 300)) {
                    peaks.push(points[i]);
                }
            }
        }

        if (peaks.length >= 2) {
            // Blink on latest beat
            if(elapsed - peaks[peaks.length-1].t < 100) triggerVisualBeat();
            
            // Calculate RR Intervals
            const intervals = [];
            for(let i=1; i<peaks.length; i++) intervals.push(peaks[i].t - peaks[i-1].t);
            
            // Rolling Average BPM
            const recentIntervals = intervals.slice(-5);
            const avgInterval = recentIntervals.reduce((a,b)=>a+b,0) / recentIntervals.length;
            const bpm = Math.round(60000 / avgInterval);
            
            if(bpm > 40 && bpm < 210) {
                finalBPM = bpm;
                document.getElementById('big-val').innerText = bpm;
                
                // HRV (RMSSD calculation)
                if(intervals.length > 2) {
                    let sumSquaredDiff = 0;
                    for(let i=1; i<intervals.length; i++) {
                        const diff = intervals[i] - intervals[i-1];
                        sumSquaredDiff += diff * diff;
                    }
                    const rmssd = Math.sqrt(sumSquaredDiff / (intervals.length - 1));
                    finalHRV = Math.round(rmssd);
                    document.getElementById('hrv-val').innerText = finalHRV;
                    
                    // Stress Estimate (Simplified inverse of HRV)
                    // High HRV (>50) = Low Stress. Low HRV (<20) = High Stress.
                    let stressRaw = 100 - (finalHRV * 1.5);
                    finalStress = Math.max(0, Math.min(100, Math.round(stressRaw)));
                    document.getElementById('stress-rt').innerText = finalStress;
                    
                    // PI capture
                    finalPI = document.getElementById('pi-val').innerText;
                }
            }
        }
    }

    function finishScan() {
        isScanning = false;
        if (stream) stream.getTracks().forEach(t => t.stop());
        camFrame.classList.remove('active-cam');
        
        // --- Generate Final Report Logic ---
        const maxHR = 220 - userAge;
        const percentMax = (finalBPM / maxHR) * 100;
        
        let zoneColor = "#10b981"; // green
        if(percentMax < 50) cardioZone = "Warm Up";
        else if(percentMax < 70) { cardioZone = "Fat Burn"; zoneColor = "#f59e0b"; }
        else if(percentMax < 85) { cardioZone = "Cardio"; zoneColor = "#f97316"; }
        else { cardioZone = "Peak"; zoneColor = "#ef4444"; }

        // Mood/Energy Logic
        let moodStr = "Balanced";
        let moodColor = "#3b82f6";
        let energyLevel = 50;
        
        if(finalHRV > 50 && finalBPM < 70) { moodStr = "Zen / Calm"; moodColor = "#10b981"; energyLevel = 80; }
        else if(finalHRV < 25 && finalBPM > 90) { moodStr = "Stressed / Anxious"; moodColor = "#ef4444"; energyLevel = 30; }
        else if(finalHRV > 40 && finalBPM > 90) { moodStr = "Excited / Active"; moodColor = "#f59e0b"; energyLevel = 90; }
        else if(finalHRV < 25 && finalBPM < 65) { moodStr = "Fatigued"; moodColor = "#64748b"; energyLevel = 20; }
        
        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();
        
        const report = document.getElementById('report-content');
        report.innerHTML = `
            <div class="report-header">CARDIAC METRICS</div>
            <div class="report-row"><span>Heart Rate</span><span style="color:var(--text-main); font-weight:800; font-size:1.1rem">${finalBPM} BPM</span></div>
            <div class="report-row"><span>Zone (${Math.round(percentMax)}%)</span><span class="score-badge" style="background:${zoneColor}20; color:${zoneColor}">${cardioZone}</span></div>
            
            <div class="report-header">AUTONOMIC HEALTH</div>
            <div class="report-row"><span>HRV (RMSSD)</span><span>${finalHRV} ms</span></div>
            <div class="report-row"><span>Stress Level</span><span style="color:${finalStress > 60 ? '#ef4444':'#10b981'}">${finalStress}/100</span></div>
            <div class="report-row"><span>Vascular Flow (PI)</span><span>${finalPI}%</span></div>
            
            <div class="report-header">AI INSIGHTS</div>
            <div class="report-row" style="display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>Est. Body State</span>
                    <span style="color:${moodColor}; font-weight:700;">${moodStr}</span>
                </div>
                <div style="font-size:0.75rem;">Energy Score</div>
                <div class="mood-scale"><div class="mood-fill" style="width:${energyLevel}%; background:${moodColor}"></div></div>
            </div>
            
            <div style="background:#f1f5f9; padding:15px; border-radius:15px; margin-top:20px; font-size:0.75rem; color:#64748b; line-height:1.4;">
                <strong style="color:var(--text-main)">Note:</strong> Not a medical device. High Stress or Low HRV may indicate fatigue, dehydration, or recovery needs.
            </div>
        `;
        
        document.getElementById('report-modal').style.display = 'flex';
        lucide.createIcons();
    }

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resize);
    resize();
</script>
</body>
</html>