<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioMed Pro: Authentic Restore</title>
    
    <link rel="icon" type="image/png" href="./icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f1f5f9">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f1f5f9;        
            --card-bg: rgba(255, 255, 255, 0.95);       
            --text-main: #1e293b;       
            --text-sub: #64748b;        
            --accent: #0ea5e9;           
            --accent-soft: #e0f2fe;     
            --heart-color: #ef4444;      
            --border-color: #e2e8f0;    
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15); 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --teal: #14b8a6;
            --teal-soft: #ccfbf1;
            --graph-bg: #f8fafc;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            /* บังคับเต็มจอเพื่อไม่ให้ scroll ที่ body */
            height: 100dvh; 
            width: 100vw;
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
        }

        .bg-grid { 
            position: fixed; inset: 0; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            opacity: 0.5; z-index: -1; 
        }

        /* --- CONTAINER (FIXED SIZE FRAME) --- */
        /* ตรงนี้คือกรอบโทรศัพท์ที่คุณต้องการ Fix ไว้ */
        .app-container { 
            width: 100%; 
            max-width: 420px; /* ขนาดกว้างสูงสุดเหมือนมือถือ */
            height: 95vh;     /* สูงเกือบเต็มจอ แต่เหลือขอบบนล่าง */
            max-height: 850px; 
            position: relative; 
            z-index: 10; 
        }

        /* --- MAIN CARD --- */
        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px);
            border-radius: 32px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.8);
            
            /* Layout Management */
            width: 100%;
            height: 100%; /* ยืดเต็ม app-container */
            padding: 20px;
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* ห้ามเนื้อหาล้นออกนอกการ์ด */
        }

        /* --- HEADER SECTIONS --- */
        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s linear; }

        .tab-nav {
            display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; 
            margin-bottom: 10px; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; border: none; background: transparent; padding: 8px; border-radius: 10px; 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.7rem; 
            color: var(--text-sub); cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 4px; transition: 0.2s;
        }
        .tab-btn.active-tab { background: #fff; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .top-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; height: 50px; flex-shrink: 0; 
        }
        
        .brand-badge { display: flex; align-items: center; gap: 8px; }
        .brand-icon-bg { background: var(--accent-soft); color: var(--accent); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 0.9rem; color: var(--text-main); }

        /* --- CAMERA FRAME (FLEXIBLE) --- */
        /* กล้องตั้งต้น (เล็ก) */
        .cam-frame { 
            width: 48px; height: 48px; 
            border-radius: 12px; 
            border: 2px solid var(--border-color); 
            overflow: hidden; 
            background: #000; 
            position: relative; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.4s ease;
        }
        .cam-frame.active-cam { border-color: var(--accent); }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0; }
        video.ready { opacity: 1; }
        .cam-placeholder { position: absolute; color: #334155; pointer-events: none; }

        /* --- LAYOUTS --- */
        .view-section { 
            display: none; 
            flex-direction: column; 
            flex: 1; /* ยืดให้เต็มพื้นที่ที่เหลือ */
            min-height: 0; /* สำคัญ! ป้องกัน Flex ล้น */
            overflow-y: auto; /* เผื่อถ้าหน้าจอเล็กมากจริงๆ ให้ scroll ได้เฉพาะส่วนเนื้อหา */
        }
        .view-section.active-view { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDIO & NEURO Styles --- */
        /* (ลดขนาดเพื่อประหยัดที่) */
        .main-value { font-family: 'JetBrains Mono', monospace; font-size: 3rem; font-weight: 800; line-height: 1; color: var(--text-main); margin: 5px 0; }
        .main-label { color: var(--text-sub); font-weight: 700; font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; }
        .display-section { text-align: center; flex-shrink: 0; margin-bottom: 10px; }
        
        #view-cardio { justify-content: space-between; padding-bottom: 5px; }
        #view-cardio .viz-box { flex-grow: 1; min-height: 80px; max-height: 150px; margin-bottom: 10px; }
        
        #view-neuro { justify-content: flex-end; gap: 10px; position: relative; }
        #view-neuro .viz-box { height: 50px; flex-shrink: 0; }
        
        /* --- DERMA LAYOUT (Revised to FIT) --- */
        #view-derma {
            /* ใช้ Flexbox จัดเรียงแนวตั้ง */
            display: none;
            flex-direction: column;
            justify-content: space-between; /* กระจายเนื้อหา */
            height: 100%;
            padding-top: 10px;
        }

        /* ปรับกล้องในโหมด Derma ให้ยืดหดตามพื้นที่ */
        .glass-card.derma-active .cam-frame {
            position: relative; /* เลิกใช้ Absolute เพื่อไม่ให้ทับคนอื่น */
            width: 100%;
            flex-grow: 1; /* ให้ขยายกินพื้นที่ว่างทั้งหมด */
            min-height: 200px; /* ความสูงขั้นต่ำ */
            max-height: 55%;   /* ห้ามสูงเกิน 55% ของหน้าจอ */
            border-radius: 24px;
            border: 2px solid var(--teal);
            box-shadow: 0 10px 20px rgba(20, 184, 166, 0.15);
            margin: 0 auto; /* จัดกึ่งกลาง */
            order: 1; /* ลำดับการแสดงผล */
        }
        
        /* Dashboard ข้อมูล */
        .derma-dash {
            background: #fff; border: 1px solid var(--teal-soft); 
            border-radius: 16px; padding: 12px; 
            box-shadow: 0 5px 15px -5px rgba(20, 184, 166, 0.1);
            margin-top: 10px;
            flex-shrink: 0; /* ห้ามหด */
            order: 2;
        }

        /* ส่วนแสดงผลตัวเลข */
        .derma-result-area {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-top: 5px;
            flex-shrink: 0;
            order: 3;
        }
        #view-derma .main-value { font-size: 2.2rem; margin: 0; color: var(--teal); }
        
        /* ปุ่มกด */
        #view-derma .btn-main { margin-top: 10px; order: 4; flex-shrink: 0; }

        /* --- COMPONENT STYLES --- */
        .viz-box { background: var(--graph-bg); border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden; position: relative; width: 100%; }
        
        /* Dashboard Elements */
        .dd-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .dd-label { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }
        .dd-bar-bg { width: 100%; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden; }
        .dd-bar-fill { height: 100%; width: 0%; background: var(--teal); transition: width 0.3s ease; }
        .dd-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: 800; background: var(--bg-color); color: var(--text-sub); }

        .btn-main { width: 100%; padding: 14px; border-radius: 14px; border: none; background: var(--text-main); color: #fff; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.2); }
        .btn-main.teal { background: var(--teal); box-shadow: 0 4px 10px rgba(20, 184, 166, 0.3); }
        .btn-main.purple { background: var(--purple); }

        /* NEURO Specific Adjustments for Fixed Container */
        .glass-card.neuro-active .cam-frame {
            position: absolute; top: 180px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--purple);
            z-index: 5;
        }

        /* --- OVERLAY ELEMENTS --- */
        .derma-scanner-overlay {
            position: absolute; inset: 0; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 70;
        }
        .glass-card.derma-active .derma-scanner-overlay { opacity: 1; }
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--teal); box-shadow: 0 0 10px var(--teal); opacity: 0.6;
            animation: scan-vertical 2s linear infinite;
        }
        @keyframes scan-vertical { 0% { top: 5%; opacity:0; } 10% { opacity:1; } 90% { opacity:1; } 100% { top: 95%; opacity:0; } }

        .face-guide-svg { width: 100%; height: 100%; position: absolute; top:0; left:0; stroke: var(--teal); stroke-width: 2; fill: none; opacity: 0.3; stroke-dasharray: 10, 5; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; }
        .stat-card { background: #f8fafc; padding: 10px 5px; border-radius: 12px; border: 1px solid var(--border-color); text-align: center; }
        .stat-val { font-family: 'JetBrains Mono'; font-size: 0.9rem; font-weight: 600; }
        .stat-lbl { font-size: 0.55rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }

        .util-row { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px; }
        .btn-util { padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: #fff; color: var(--text-sub); font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-util.active { background: var(--accent-soft); color: var(--accent); }

        .mode-menu { display: none; position: absolute; bottom: 85px; right: 20px; background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 80; flex-direction: column; width: 140px; }
        .mode-item { padding: 10px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 600; }
        .mode-item.selected { background: var(--accent-soft); color: var(--accent); }

        /* Report Modal */
        .modal { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .report-card { background: #fff; border-radius: 30px; padding: 25px; width: 90%; max-width: 380px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        .report-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; color: var(--text-sub); }
        #flash-overlay { position: fixed; inset: 0; background: white; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        
        .eye-mask { position: absolute; inset:0; display: flex; align-items: center; justify-content: center; opacity:0; pointer-events: none; }
        .neuro-active .eye-mask { opacity: 1; }
        .eye-guide-ring { width: 60px; height: 60px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; transition: 0.3s; }
        .eye-guide-ring.locked { border-color: var(--success); border-style: solid; box-shadow: 0 0 15px var(--success); }
    </style>
</head>
<body>

<div class="bg-grid"></div>
<div id="flash-overlay"></div>

<div class="app-container">
    <div class="glass-card" id="main-card">
        <div class="progress-bar"><div id="progress-fill"></div></div>

        <nav class="tab-nav">
            <button class="tab-btn active-tab" onclick="switchTab('CARDIO')">
                <i data-lucide="activity" width="14"></i> CARDIO
            </button>
            <button class="tab-btn" onclick="switchTab('NEURO')">
                <i data-lucide="eye" width="14"></i> NEURO
            </button>
            <button class="tab-btn" onclick="switchTab('DERMA')">
                <i data-lucide="droplets" width="14"></i> DERMA
            </button>
        </nav>

        <div class="top-row">
            <div class="brand-badge" id="brand-badge">
                <div class="brand-icon-bg" id="brand-bg"><i data-lucide="activity" style="width:20px;"></i></div>
                <div>
                    <div class="brand-text">BIOMED</div>
                    <div style="font-size:0.6rem; color:var(--text-sub); font-weight:600;">PRO ANALYZER</div>
                </div>
            </div>
            
            <div style="display:flex; gap:8px; align-items:center;">
                <button onclick="clearCacheApp()" style="background:transparent; border:none; color:#94a3b8; cursor:pointer;">
                    <i data-lucide="rotate-ccw" width="18"></i>
                </button>
                <button onclick="toggleTorchManual()" id="torch-btn" style="display:none;"></button>
                
                <div class="cam-frame" id="camFrame">
                    <div class="cam-placeholder"><i data-lucide="camera-off" width="20"></i></div>
                    <video id="webcam" playsinline autoplay muted></video>
                    
                    <div class="fingerprint-guide" style="opacity:0; transition:0.3s"><i data-lucide="fingerprint" width="32"></i></div>
                    <div class="neuro-crosshair" style="opacity:0; transition:0.3s"></div>
                    <div class="eye-mask"><div class="eye-guide-ring" id="eye-target"></div></div>
                    
                    <div class="derma-scanner-overlay">
                        <div class="scan-line"></div>
                        <svg class="face-guide-svg" viewBox="0 0 100 130">
                             <path d="M20,40 Q20,10 50,10 T80,40 V80 Q80,120 50,120 T20,80 Z" />
                        </svg>
                        <canvas id="derma-overlay" width="200" height="200" style="position:absolute; inset:0; width:100%; height:100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-cardio" class="view-section active-view">
            <div class="display-section">
                <div class="main-label">HEART RATE</div>
                <div id="heart-wrapper" style="opacity: 0; transition: opacity 0.3s;">
                     <i data-lucide="heart" style="width: 28px; color: var(--heart-color); fill: var(--heart-color);"></i>
                </div>
                <div class="main-value" id="big-val">--</div>
                <div id="status-msg" style="font-size:0.75rem; color:var(--text-sub);">Place Finger</div>
            </div>

            <div class="viz-box" id="graph-box">
                <canvas id="graph"></canvas>
                <div style="position:absolute; bottom:5px; left:10px; font-size:0.55rem; color:var(--text-sub);">PPG SIGNAL</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card"><div class="stat-lbl">Stress</div><div class="stat-val" id="stress-rt">--</div></div>
                <div class="stat-card"><div class="stat-lbl">HRV</div><div class="stat-val" id="hrv-val">--</div></div>
                <div class="stat-card"><div class="stat-lbl">PI %</div><div class="stat-val" id="pi-val">--</div></div>
            </div>

            <div class="util-row">
                <button class="btn-util active" id="btn-breath" onclick="toggleBreathMenu()"><i data-lucide="wind" width="14"></i> <span id="breath-lbl">Normal</span></button>
            </div>
            
            <div class="mode-menu" id="breath-menu">
                <div class="mode-item selected" onclick="setBreathMode('normal', this)">Normal</div>
                <div class="mode-item" onclick="setBreathMode('relax', this)">Relax (4-7-8)</div>
                <div class="mode-item" onclick="setBreathMode('focus', this)">Focus (Box)</div>
            </div>

            <button id="pre-start-btn" class="btn-main" onclick="openAgeModal()" style="margin-top:auto;"><i data-lucide="power" width="16"></i> START ANALYSIS</button>
        </div>

        <div id="view-neuro" class="view-section">
            <div class="display-section" style="margin-top:20px;">
                <div class="main-label">REFLEX LATENCY</div>
                <div class="main-value" id="neuro-val">--</div>
                <div id="neuro-msg" style="font-size:0.75rem; color:var(--text-sub);">Align Eye</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Constrict</div><div class="stat-val" id="constrict-val">--</div></div>
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Dilate</div><div class="stat-val" id="dilate-val">--</div></div>
            </div>

            <div class="viz-box">
                <canvas id="neuro-graph" style="width:100%; height:100%;"></canvas>
            </div>

            <button class="btn-main purple" onclick="startNeuro()">
                <i data-lucide="zap" width="16"></i> START TEST
            </button>
        </div>

        <div id="view-derma" class="view-section">
            <div class="derma-dash">
                <div class="dd-row">
                    <div class="dd-label">Oil Intensity</div>
                    <div class="dd-badge" id="rt-oil-badge">--</div>
                </div>
                <div class="dd-bar-bg"><div class="dd-bar-fill" id="rt-oil-bar"></div></div>
                
                <div class="dd-row" style="margin-top:10px;">
                    <div class="dd-label">Risk Level</div>
                    <div class="dd-badge" id="rt-risk-badge">--</div>
                </div>
                <div class="dd-bar-bg"><div class="dd-bar-fill" id="rt-risk-bar" style="background:var(--warning)"></div></div>
            </div>

            <div class="derma-result-area">
                 <div style="text-align:left;">
                    <div class="main-label">DETECTED SHINE</div>
                    <div class="main-value" id="derma-val">--%</div>
                 </div>
                 <div id="derma-msg" style="font-size:0.7rem; color:var(--text-sub); text-align:right; max-width:100px; font-weight:600; padding-bottom:5px;">Scan T-Zone</div>
            </div>

            <button class="btn-main teal" onclick="startDerma()">
                <i data-lucide="scan-face" width="16"></i> SCAN SURFACE
            </button>
        </div>

    </div>
</div>

<div class="modal" id="age-modal">
    <div class="report-card">
        <h2 style="color:var(--text-main); margin-top:0;">CALIBRATION</h2>
        <div class="input-group" style="margin-bottom:15px;"><input type="number" id="age-input" placeholder="Age" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; text-align:center; font-size:1.2rem;"></div>
        <button onclick="confirmAge()" class="btn-main">INITIALIZE</button>
    </div>
</div>

<div class="modal" id="report-modal">
    <div class="report-card" style="max-height:80vh; overflow-y:auto;">
        <div style="text-align:center;"><i data-lucide="activity" style="color:var(--accent); width:40px; height:40px;"></i></div>
        <h2 style="color:var(--text-main); margin:5px 0 15px; text-align:center;">REPORT</h2>
        <div style="font-size:0.7rem; color:var(--text-sub); margin-bottom:15px; text-align:center;" id="timestamp-str"></div>
        <div id="report-content"></div>
        <button onclick="resetScan()" class="btn-main" style="margin-top:15px;">DONE</button>
    </div>
</div>

<canvas id="proc" width="50" height="50" style="display:none"></canvas>

<script>
    lucide.createIcons();
    let stream = null;
    let audioCtx = null;
    let torchState = false;
    let currentTab = 'CARDIO';
    let isScanning = false, isNeuroTesting = false, isDermaScanning = false;
    const video = document.getElementById('webcam');
    const camFrame = document.getElementById('camFrame');
    const proc = document.getElementById('proc').getContext('2d');

    // Init Camera
    async function initCamera() {
        if(stream) return; 
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: {ideal: 300}, height: {ideal: 300} } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.classList.add('ready');
                camFrame.classList.add('active-cam');
                document.querySelector('.cam-placeholder').style.display = 'none';
                requestAnimationFrame(loop);
            };
        } catch(e) { console.log("Cam Error"); }
    }
    initCamera();

    // Switch Tab Logic
    function switchTab(tab) {
        if(isScanning || isNeuroTesting || isDermaScanning) return;
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        event.currentTarget.classList.add('active-tab');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
        
        const card = document.getElementById('main-card');
        const bg = document.getElementById('brand-bg');
        card.className = "glass-card"; 
        document.getElementById('brand-badge').style.opacity = '1';

        if(tab === 'CARDIO') {
            document.getElementById('view-cardio').classList.add('active-view');
            bg.style.background = 'var(--accent-soft)'; bg.style.color = 'var(--accent)';
            bg.innerHTML = '<i data-lucide="activity" width="20"></i>';
            document.querySelector('.fingerprint-guide').style.opacity = 1;
        } else if(tab === 'NEURO') {
            document.getElementById('view-neuro').classList.add('active-view');
            card.classList.add('neuro-active');
            bg.style.background = '#ede9fe'; bg.style.color = 'var(--purple)';
            bg.innerHTML = '<i data-lucide="eye" width="20"></i>';
            document.querySelector('.fingerprint-guide').style.opacity = 0;
        } else if(tab === 'DERMA') {
            document.getElementById('view-derma').classList.add('active-view');
            card.classList.add('derma-active');
            bg.style.background = '#ccfbf1'; bg.style.color = 'var(--teal)';
            bg.innerHTML = '<i data-lucide="droplets" width="20"></i>';
            document.querySelector('.fingerprint-guide').style.opacity = 0;
        }
        lucide.createIcons();
    }

    // Utility
    function toggleTorchManual() { toggleTorch(!torchState); }
    async function toggleTorch(on) { 
        if(!stream) return; 
        try { await stream.getVideoTracks()[0].applyConstraints({ advanced: [{ torch: on }] }); torchState = on; } catch(e){} 
    }
    function playBeep(freq=800) {
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.frequency.value=freq; g.gain.setValueAtTime(0.05,audioCtx.currentTime); 
        g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.1);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1);
    }
    function clearCacheApp() { if(confirm('Reset?')) { localStorage.clear(); location.reload(); } }
    function openAgeModal() { document.getElementById('age-modal').style.display = 'flex'; }
    function confirmAge() { document.getElementById('age-modal').style.display = 'none'; isScanning=true; startT=Date.now(); toggleTorch(true); }
    function resetScan() {
        document.getElementById('report-modal').style.display = 'none';
        isScanning=false; isNeuroTesting=false; isDermaScanning=false; toggleTorch(false);
        switchTab(currentTab); // Reset View
        document.getElementById('derma-val').innerText = "--%";
        document.getElementById('rt-oil-bar').style.width = "0%";
        document.getElementById('rt-oil-badge').innerText = "--";
    }

    // --- LOGIC: Derma ---
    let dermaStartT=0, dermaShiny=0, dermaTotal=0;
    function isSkinPixel(r,g,b) { return (r>60 && g>40 && b>20) && (r>g && r>b) && (Math.abs(r-g)>10); }
    
    async function startDerma() {
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();
        isDermaScanning = true; dermaStartT = Date.now(); dermaShiny=0; dermaTotal=0;
        document.getElementById('derma-val').innerText = "SCANNING";
        toggleTorch(true);
    }

    function runDerma() {
        const t = Date.now() - dermaStartT;
        document.getElementById('progress-fill').style.width = Math.min((t/4000)*100, 100)+"%";
        
        const cvs = document.getElementById('derma-overlay');
        const ctx = cvs.getContext('2d');
        ctx.clearRect(0,0,200,200);

        proc.drawImage(video,0,0,50,50);
        const data = proc.getImageData(0,0,50,50).data;
        let shiny=0, skin=0;
        const cellW = cvs.width/50, cellH = cvs.height/50;

        for(let y=0; y<50; y++) {
            for(let x=0; x<50; x++) {
                const i=(y*50+x)*4;
                const r=data[i], g=data[i+1], b=data[i+2];
                const l = 0.299*r + 0.587*g + 0.114*b;
                if(isSkinPixel(r,g,b)) {
                    skin++;
                    if(l>160) {
                        shiny++;
                        ctx.fillStyle="rgba(20,184,166,0.8)";
                        ctx.fillRect(x*cellW, y*cellH, cellW, cellH);
                    }
                }
            }
        }

        if(skin>5) {
            const ratio = (shiny/skin)*100;
            dermaShiny = (dermaShiny*0.9) + (ratio*0.1);
            
            let oilScore = Math.min(100, Math.round(dermaShiny*2.5));
            document.getElementById('derma-val').innerText = dermaShiny.toFixed(1)+"%";
            document.getElementById('rt-oil-bar').style.width = Math.min(100, oilScore)+"%";
            document.getElementById('rt-oil-badge').innerText = oilScore;
            
            let risk = (dermaShiny/30)*100;
            document.getElementById('rt-risk-bar').style.width = Math.min(100, risk)+"%";
            
            if(dermaShiny>20) { document.getElementById('rt-risk-badge').innerText="HIGH"; document.getElementById('rt-risk-badge').style.color="var(--danger)"; }
            else { document.getElementById('rt-risk-badge').innerText="NORMAL"; document.getElementById('rt-risk-badge').style.color="var(--text-sub)"; }
        }

        if(t>4000) {
            isDermaScanning=false; toggleTorch(false);
            document.getElementById('report-content').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:3rem; font-weight:800; color:var(--teal);">${dermaShiny.toFixed(1)}%</div>
                    <div style="color:var(--text-sub);">SHINE LEVEL</div>
                </div>`;
            document.getElementById('report-modal').style.display='flex';
        }
    }

    // --- Loop ---
    function loop() {
        if(!stream) return;
        if(isDermaScanning) runDerma();
        requestAnimationFrame(loop);
    }
</script>
</body>
</html>