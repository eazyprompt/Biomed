<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioMed</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❤️</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --bg-color: #f1f5f9;      
            --card-bg: #ffffff;       
            --text-main: #1e293b;     
            --text-sub: #64748b;      
            --accent: #0ea5e9;        
            --accent-soft: #e0f2fe;   
            --heart-color: #ef4444;   
            --border-color: #e2e8f0;  
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1); 
            
            /* Graph Theme Colors */
            --graph-bg: #f8fafc;
            --graph-grid: #e2e8f0;
            --graph-text: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden; 
        }

        .app-container { width: 95%; max-width: 400px; z-index: 10; position: relative; }

        .bg-grid { 
            position: fixed; inset: 0; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            opacity: 0.5;
            z-index: -1; 
        }

        .glass-card { 
            background: var(--card-bg); 
            border-radius: 32px; 
            padding: 24px; 
            box-shadow: var(--shadow); 
            border: 1px solid #fff;
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            position: relative; 
        }
        
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .brand-badge { display: flex; align-items: center; gap: 10px; }
        .brand-icon-bg { background: var(--accent-soft); color: var(--accent); width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.2rem; color: var(--text-main); letter-spacing: -0.5px; }

        .cam-frame { width: 50px; height: 50px; border-radius: 14px; border: 2px solid var(--accent); overflow: hidden; background: #000; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); transition: 0.2s; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .display-section { text-align: center; position: relative; margin: 10px 0; }
        .main-value { font-family: 'JetBrains Mono', monospace; font-size: 4.5rem; font-weight: 800; line-height: 1; color: var(--text-main); margin: 5px 0; }
        .main-label { color: var(--text-sub); font-weight: 700; font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; }

        #heart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px 0;
            height: 50px;
        }
        
        @keyframes pop-beat {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); }
            20% { transform: scale(1.4); filter: drop-shadow(0 0 15px var(--heart-color)); }
            40% { transform: scale(1); filter: drop-shadow(0 0 0 var(--heart-color)); }
            100% { transform: scale(1); }
        }

        .pop-active { animation: pop-beat 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Graph Box Styling */
        .viz-box { 
            height: 150px; /* Increased height for labels */
            background: var(--graph-bg); 
            border-radius: 20px; 
            border: 1px solid var(--border-color); 
            overflow: hidden; 
            position: relative; 
        }
        
        #breath-guide { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; }
        .breath-circle { width: 50px; height: 50px; border-radius: 50%; background: var(--accent); opacity: 0.3; box-shadow: 0 0 15px var(--accent); animation: breathe-anim 8s ease-in-out infinite; }
        @keyframes breathe-anim { 0%, 100% { transform: scale(0.5); opacity: 0.1; } 50% { transform: scale(1.5); opacity: 0.4; } }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: #f8fafc; padding: 14px; border-radius: 16px; border: 1px solid var(--border-color); }
        .stat-lbl { font-size: 0.65rem; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--text-main); font-weight: 600; }
        
        .util-row { display: flex; gap: 10px; }
        .btn-util { flex: 1; padding: 12px; border-radius: 14px; border: 1px solid var(--border-color); background: #fff; color: var(--text-sub); font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-util.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent-soft); }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--text-main); color: #fff; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 5px; box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2); }
        .btn-main:active { transform: scale(0.98); }

        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s linear; }
        
        #overlay, .modal { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        #overlay-text { font-family: 'Outfit'; margin-top: 15px; font-size: 1rem; font-weight: 600; color: var(--text-main); }
        #overlay-icon { color: var(--accent); }

        .report-card { background: #fff; border-radius: 30px; padding: 30px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid var(--border-color); }
        .report-stat { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-family: 'JetBrains Mono'; font-size: 0.9rem; color: var(--text-sub); }
        .report-header { font-size: 0.75rem; color: var(--accent); text-align: left; margin-top: 20px; margin-bottom: 8px; font-weight: 800; letter-spacing: 1px; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        
        @keyframes pulse-beat-frame { 0% { transform: scale(1); border-color: var(--accent); } 50% { transform: scale(1.05); border-color: #38bdf8; } 100% { transform: scale(1); border-color: var(--accent); } }
        .cam-frame.beating { animation: pulse-beat-frame 0.1s ease-out; }
        
        .input-group { margin-bottom: 20px; width: 100%; }
        .input-group input { width: 100%; background: #f1f5f9; border: 1px solid var(--border-color); color: var(--text-main); padding: 15px; border-radius: 15px; font-family: 'JetBrains Mono'; font-size: 1.2rem; text-align: center; outline: none; }
        .input-group input:focus { border-color: var(--accent); background: #fff; }
    </style>
</head>
<body>

<div class="bg-grid"></div>

<div class="app-container">
    <div class="glass-card">
        <div class="progress-bar"><div id="progress-fill"></div></div>

        <div class="top-row">
            <div class="brand-badge">
                <div class="brand-icon-bg"><i data-lucide="activity" style="width:20px;"></i></div>
                <div class="brand-text">BIOSCANNER</div>
            </div>
            <button onclick="toggleTorch()" id="torch-btn" style="background:transparent; border:none; color:#94a3b8; cursor:pointer; padding:8px;"><i data-lucide="flashlight"></i></button>
            <div class="cam-frame" id="camFrame"><video id="webcam" playsinline autoplay muted></video></div>
        </div>

        <div class="display-section">
            <div class="main-label">HEART RATE (BPM)</div>
            
            <div id="heart-wrapper" style="opacity: 0; transition: opacity 0.3s;">
                 <i data-lucide="heart" style="width: 45px; height: 45px; color: var(--heart-color); fill: var(--heart-color);"></i>
            </div>
            
            <div class="main-value" id="big-val">--</div>
        </div>

        <div class="viz-box" id="graph-box">
            <div id="breath-guide"><div class="breath-circle"></div></div>
            <canvas id="graph"></canvas>
        </div>

        <div class="util-row">
            <button class="btn-util active" id="btn-sound" onclick="toggleSound()"><i data-lucide="volume-2" style="width:16px;"></i> Sound</button>
            <button class="btn-util active" id="btn-breath" onclick="toggleBreath()"><i data-lucide="wind" style="width:16px;"></i> Guide</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-lbl"><i data-lucide="heart-pulse" style="width:14px; color:var(--accent)"></i> ZONE</div>
                <div class="stat-val" id="zone-val">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl"><i data-lucide="wind" style="width:14px; color:var(--accent)"></i> BREATH</div>
                <div class="stat-val" id="breath-val">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl"><i data-lucide="fingerprint" style="width:14px; color:var(--accent)"></i> HRV</div>
                <div class="stat-val" id="hrv-val">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl"><i data-lucide="activity" style="width:14px; color:var(--accent)"></i> RHYTHM</div>
                <div class="stat-val" id="rhythm-val" style="font-size:0.8rem">--</div>
            </div>
        </div>

        <button id="pre-start-btn" class="btn-main" onclick="openAgeModal()"><i data-lucide="power"></i> START SCAN</button>
    </div>
</div>

<div class="modal" id="age-modal" style="display:none;">
    <div class="report-card">
        <h2 style="color:var(--text-main); margin-top:0;">CALIBRATION</h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Please enter your age to begin.</p>
        <div class="input-group"><input type="number" id="age-input" placeholder="Age (e.g. 25)" inputmode="numeric"></div>
        <button onclick="confirmAge()" class="btn-main">CONFIRM</button>
    </div>
</div>
<div id="overlay"><div id="overlay-icon"></div><div id="overlay-text"></div></div>
<div class="modal" id="report-modal">
    <div class="report-card">
        <div style="width:60px; height:60px; background:var(--accent-soft); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px;"><i data-lucide="check" style="width:30px; height:30px; color:var(--accent);"></i></div>
        <h2 style="color:var(--text-main); margin:0; font-size:1.5rem;">SCAN COMPLETE</h2>
        <div id="report-content" style="margin: 20px 0; text-align: left;"></div>
        <button onclick="location.reload()" class="btn-main" style="background:var(--accent)">DONE</button>
    </div>
</div>
<canvas id="proc" width="50" height="50" style="display:none"></canvas>

<script>
    lucide.createIcons();

    let isScanning = false, stream = null, points = [], startT;
    let finalBPM = 0, finalHRV = 0, finalBreath = 0;
    let userAge = 25;
    let rhythmStatus = "NORMAL", vascularIndex = "NORMAL", autonomicBalance = "BALANCED", cardioZone = "RESTING";
    let signalBuffer = []; 
    const SMOOTHING_WINDOW = 7, TIME_LIMIT = 30000; 
    
    const canvas = document.getElementById('graph'), ctx = canvas.getContext('2d'), video = document.getElementById('webcam');
    const camFrame = document.getElementById('camFrame');
    const heartWrapper = document.getElementById('heart-wrapper');

    let audioCtx = null, soundEnabled = true, breathGuide = true, torchState = false;

    function openAgeModal() { document.getElementById('age-modal').style.display = 'flex'; document.getElementById('age-input').focus(); }
    function confirmAge() {
        const input = document.getElementById('age-input').value;
        if(input && input > 5 && input < 100) userAge = parseInt(input);
        document.getElementById('age-modal').style.display = 'none';
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
        startCamera();
    }
    function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('btn-sound').classList.toggle('active', soundEnabled); if(soundEnabled && !audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(soundEnabled && audioCtx.state === 'suspended') audioCtx.resume(); }
    function playBeep(freq = 800) { if(!soundEnabled || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.frequency.value = freq; osc.type = 'sine'; gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function toggleBreath() { breathGuide = !breathGuide; document.getElementById('btn-breath').classList.toggle('active', breathGuide); document.getElementById('breath-guide').style.display = breathGuide ? 'flex' : 'none'; }
    async function toggleTorch() { if(!stream) return; torchState = !torchState; const track = stream.getVideoTracks()[0]; try { await track.applyConstraints({ advanced: [{ torch: torchState }] }); document.getElementById('torch-btn').style.color = torchState ? 'var(--accent)' : '#94a3b8'; } catch(e) { alert("Flashlight not supported on this device."); } }
    function showOverlay(text, iconName, isSpinning = false) { const overlay = document.getElementById('overlay'); overlay.style.display = 'flex'; document.getElementById('overlay-text').innerText = text; document.getElementById('overlay-icon').innerHTML = `<i data-lucide="${iconName}" class="${isSpinning ? 'spinning' : ''}"></i>`; lucide.createIcons(); }

    async function startCamera() {
        try {
            showOverlay("Starting Camera...", "loader-2", true);
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            const track = stream.getVideoTracks()[0];
            try { const caps = track.getCapabilities(); if(caps.torch) { await track.applyConstraints({ advanced: [{ torch: true }] }); torchState = true; document.getElementById('torch-btn').style.color = 'var(--accent)'; } } catch(e){}
            showOverlay("Calibrating...", "refresh-cw", true);
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                isScanning = true; points = []; signalBuffer = []; startT = Date.now();
                document.getElementById('pre-start-btn').style.display = 'none';
                requestAnimationFrame(loop);
            }, 2500);
        } catch(e) { showOverlay("Camera Error. Check Permissions.", "alert-triangle"); }
    }

    function loop() {
        if (!isScanning) return;
        const elapsed = Date.now() - startT;
        document.getElementById('progress-fill').style.width = (elapsed/TIME_LIMIT)*100 + "%";
        const pCanvas = document.getElementById('proc'), pCtx = pCanvas.getContext('2d');
        pCtx.drawImage(video, 0, 0, 50, 50);
        const data = pCtx.getImageData(0,0,50,50).data;
        let rTotal = 0, gTotal = 0, bTotal = 0;
        for(let i=0; i<data.length; i+=4) { rTotal += data[i]; gTotal += data[i+1]; bTotal += data[i+2]; }
        const pixels = data.length / 4;
        const avgR = rTotal / pixels, avgG = gTotal / pixels, avgB = bTotal / pixels;
        const isFingerPresent = (avgR > avgG * 1.3) && (avgR > avgB * 1.3) && (avgR > 40) && (avgR < 250);

        if (!isFingerPresent) {
            document.getElementById('big-val').innerText = "Place Finger";
            document.getElementById('big-val').style.fontSize = "2.5rem";
            document.getElementById('graph-box').style.opacity = 0.5;
            heartWrapper.style.opacity = 0;
            if (elapsed < TIME_LIMIT) requestAnimationFrame(loop); else finishScan();
            return;
        } else {
             if(document.getElementById('big-val').innerText === "Place Finger") {
                 document.getElementById('big-val').innerText = "--";
                 document.getElementById('big-val').style.fontSize = "4.5rem";
             }
             document.getElementById('graph-box').style.opacity = 1;
             heartWrapper.style.opacity = 1;
        }

        let rawVal = avgR / 2500;
        signalBuffer.push(rawVal);
        if (signalBuffer.length > SMOOTHING_WINDOW) signalBuffer.shift();
        let weightedSum = 0, weightTotal = 0;
        signalBuffer.forEach((val, i) => { const weight = i + 1; weightedSum += val * weight; weightTotal += weight; });
        let smoothedVal = weightedSum / weightTotal;
        points.push({ t: elapsed, v: smoothedVal });
        if (points.length > 150) points.shift();
        renderGraph();
        if (points.length > 50) analyze(elapsed);
        if (elapsed < TIME_LIMIT) requestAnimationFrame(loop); else finishScan();
    }

    function renderGraph() {
        // --- 1. Setup Canvas & Padding ---
        ctx.clearRect(0,0,canvas.width,canvas.height);
        
        // Settings for "Math Plot" look
        const padding = { top: 15, right: 10, bottom: 20, left: 35 };
        const w = canvas.width - padding.left - padding.right;
        const h = canvas.height - padding.top - padding.bottom;
        
        // --- 2. Calculate Data Range ---
        if (points.length < 2) return;
        const plotPoints = points.map((p,i,arr) => { if(i<2 || i>arr.length-3) return p.v; return (arr[i-2].v + arr[i-1].v + p.v + arr[i+1].v + arr[i+2].v) / 5; });
        const min = Math.min(...plotPoints);
        const max = Math.max(...plotPoints);
        const range = (max - min) || 1;

        // --- 3. Draw Grid & Axes ---
        ctx.lineWidth = 1;
        ctx.font = "bold 9px JetBrains Mono";
        
        // Draw Horizontal Grid & Y-Axis Labels
        for(let i=0; i<=4; i++) {
            const yRatio = i / 4;
            const y = padding.top + h - (h * yRatio);
            const val = min + (range * yRatio);
            
            // Grid Line
            ctx.beginPath();
            ctx.strokeStyle = "rgba(100, 116, 139, 0.2)"; // Light grid color
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + w, y);
            ctx.stroke();

            // Label
            ctx.fillStyle = "#64748b";
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";
            ctx.fillText(val.toFixed(2), padding.left - 5, y);
        }

        // Draw Vertical Grid (X-Axis) - Approx 5 steps
        for(let i=0; i<=5; i++) {
            const x = padding.left + (w * (i/5));
            ctx.beginPath();
            ctx.strokeStyle = "rgba(100, 116, 139, 0.1)"; 
            ctx.moveTo(x, padding.top);
            ctx.lineTo(x, padding.top + h);
            ctx.stroke();
        }

        // --- 4. Draw Main Graph Line ---
        ctx.beginPath();
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';
        
        const step = w / (points.length - 1);
        let lastX = 0, lastY = 0;
        
        points.forEach((p, i) => { 
            const y = padding.top + h - ((plotPoints[i] - min)/range * h);
            const x = padding.left + (i * step);
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
            if (i === points.length - 1) { lastX = x; lastY = y; }
        });
        ctx.stroke();

        // --- 5. Draw "Current Point" Dot ---
        ctx.beginPath();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
        ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
        ctx.fill();
    }

    function triggerVisualBeat() {
        camFrame.classList.remove('beating');
        void camFrame.offsetWidth;
        camFrame.classList.add('beating');
        
        heartWrapper.classList.remove('pop-active');
        void heartWrapper.offsetWidth; 
        heartWrapper.classList.add('pop-active');

        playBeep(880); 
    }

    function analyze(elapsed) {
        let peaks = [];
        for (let i = 7; i < points.length-7; i++) {
            let isMax = true;
            for(let j=-7; j<=7; j++) { if(points[i].v < points[i+j].v) isMax = false; }
            if(isMax && (peaks.length === 0 || points[i].t - peaks[peaks.length-1].t > 350)) peaks.push(points[i]);
        }
        if (peaks.length >= 3) {
            if(elapsed - peaks[peaks.length-1].t < 100) triggerVisualBeat();
            const intervals = [];
            for(let i=1; i<peaks.length; i++) intervals.push(peaks[i].t - peaks[i-1].t);
            const recentIntervals = intervals.slice(-4);
            const avgRecentInterval = recentIntervals.reduce((a,b)=>a+b,0) / recentIntervals.length;
            const bpm = Math.round(60000 / avgRecentInterval);
            
            if(bpm > 40 && bpm < 200) {
                finalBPM = bpm;
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                finalHRV = Math.round(Math.sqrt(intervals.map(x => Math.pow(x - avgInterval, 2)).reduce((a, b) => a + b) / intervals.length));
                let br = Math.round(60 / (avgInterval * 4 / 1000));
                finalBreath = Math.max(12, Math.min(25, br || 16));
                const maxHR = 220 - userAge;
                const percentMax = (bpm / maxHR) * 100;
                if(percentMax < 50) cardioZone = "Resting"; else if(percentMax < 60) cardioZone = "Warm Up"; else if(percentMax < 70) cardioZone = "Fat Burn"; else if(percentMax < 80) cardioZone = "Cardio"; else cardioZone = "Peak";
                
                let irregularityCount = 0;
                for(let i=1; i<recentIntervals.length; i++) { if(Math.abs(recentIntervals[i] - recentIntervals[i-1]) > (recentIntervals[i-1] * 0.15)) irregularityCount++; }
                rhythmStatus = irregularityCount > 1 ? "Irregular" : "Normal";
                autonomicBalance = finalHRV < 25 ? "Stressed" : (finalHRV > 60 ? "Relaxed" : "Balanced");
                
                document.getElementById('big-val').innerText = bpm;
                document.getElementById('zone-val').innerText = cardioZone;
                document.getElementById('rhythm-val').innerText = rhythmStatus;
                document.getElementById('rhythm-val').style.color = rhythmStatus === "Normal" ? "var(--text-main)" : "#eab308";
                document.getElementById('hrv-val').innerText = finalHRV;
                document.getElementById('breath-val').innerText = finalBreath;
                if(navigator.vibrate && elapsed % 1000 < 50) navigator.vibrate(5);
            }
        }
    }

    function finishScan() {
        isScanning = false;
        if (stream) stream.getTracks().forEach(t => t.stop());
        camFrame.classList.remove('beating');
        heartWrapper.style.opacity = 0;
        
        const report = document.getElementById('report-content');
        report.innerHTML = `
            <div class="report-header">CARDIAC VITALS</div>
            <div class="report-stat"><span>Heart Rate</span><span style="color:var(--text-main); font-weight:bold">${finalBPM} BPM</span></div>
            <div class="report-stat"><span>Rhythm</span><span style="color:${rhythmStatus==='Normal'?'var(--accent)':'#eab308'}">${rhythmStatus}</span></div>
            <div class="report-stat"><span>HRV (Stability)</span><span>${finalHRV} ms</span></div>
            <div class="report-header">PHYSIOLOGICAL ANALYSIS</div>
            <div class="report-stat"><span>Autonomic System</span><span style="color:${autonomicBalance==='Stressed'?'#eab308':'var(--accent)'}">${autonomicBalance}</span></div>
            <div class="report-stat"><span>Breath Rate</span><span>${finalBreath} /min</span></div>
            <div class="report-header">TRAINING METRICS (Age: ${userAge})</div>
            <div class="report-stat"><span>Max HR Estimate</span><span>${220-userAge} BPM</span></div>
            <div class="report-stat"><span>Current Zone</span><span style="color:var(--accent)">${cardioZone}</span></div>
        `;
        document.getElementById('report-modal').style.display = 'flex';
        lucide.createIcons();
    }

    function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    window.addEventListener('resize', resize);
    resize();
</script>
</body>
</html>