<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioMed Pro: Derma Scanner</title>
    
    <link rel="icon" type="image/png" href="./icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f1f5f9">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.321.0/dist/umd/lucide.min.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f1f5f9;        
            --card-bg: rgba(255, 255, 255, 0.95);       
            --text-main: #1e293b;       
            --text-sub: #64748b;        
            --accent: #0ea5e9;            
            --accent-soft: #e0f2fe;     
            --heart-color: #ef4444;       
            --border-color: #e2e8f0;    
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15); 
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --teal: #14b8a6;
            --graph-bg: #f8fafc;
        }

/* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #view-derma #derma-msg ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á <style> */

#view-derma #derma-msg {
    position: absolute;
    width: 100%;
    text-align: center;
    z-index: 20;
    
    /* ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å: Top ‡∏Å‡∏•‡πâ‡∏≠‡∏á (80px) + ‡∏™‡∏π‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (240px) + ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (10px) = 330px */
    top: -20px; 
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
    font-size: 1rem !important;
    font-weight: 600;
    color: var(--text-sub);
    text-shadow: 0 1px 2px rgba(255,255,255,0.8);
}

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden; 
        }

        .app-container { width: 95%; max-width: 420px; z-index: 10; position: relative; }

        .bg-grid { 
            position: fixed; inset: 0; 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            opacity: 0.5; z-index: -1; 
        }

        /* --- MAIN CARD --- */
        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px);
            border-radius: 32px; 
            padding: 24px; 
            box-shadow: var(--shadow); 
            border: 1px solid rgba(255,255,255,0.8);
            display: flex; 
            flex-direction: column; 
            position: relative; 
            height: 740px; 
            max-height: 95vh; 
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* --- TAB NAVIGATION --- */
        .tab-nav {
            display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; 
            margin-bottom: 10px; flex-shrink: 0;
        }
        .tab-btn {
            flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.75rem; 
            color: var(--text-sub); cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 4px; transition: 0.2s;
        }
        .tab-btn.active-tab { background: #fff; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* --- TOP HEADER --- */
        .top-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 5px; height: 60px; position: relative; z-index: 20; flex-shrink: 0; 
        }
        
        .brand-badge { display: flex; align-items: center; gap: 10px; transition: opacity 0.3s; }
        .brand-icon-bg { background: var(--accent-soft); color: var(--accent); width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.5px; }

        /* --- CAMERA FRAME --- */
        .cam-frame { 
            width: 56px; height: 56px; 
            border-radius: 16px; 
            border: 3px solid var(--border-color); 
            overflow: hidden; 
            background: #000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); 
            position: relative; 
            z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .cam-frame.active-cam { border-color: var(--accent); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        
        /* NON-MIRRORED VIDEO */
        video { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; opacity: 0; }
        video.ready { opacity: 1; }
        .cam-placeholder { position: absolute; color: #334155; pointer-events: none; }

        /* --- GUIDES --- */
        .fingerprint-guide, .neuro-crosshair, .derma-grid {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 60;
        }
        .fingerprint-guide { color: rgba(239, 68, 68, 0.6); }
        .fingerprint-guide svg { animation: pulse-red 2s infinite ease-in-out; }
        @keyframes pulse-red { 0%, 100% { opacity: 0.4; transform: scale(0.95); } 50% { opacity: 0.8; transform: scale(1.05); } }
        
        .neuro-crosshair { z-index: 65; }
        .neuro-crosshair::before, .neuro-crosshair::after { content: ''; position: absolute; background: rgba(139, 92, 246, 0.6); border-radius: 1px; }
        .neuro-crosshair::before { width: 30px; height: 2px; } 
        .neuro-crosshair::after { width: 2px; height: 30px; }

        .derma-grid { 
            background-image: radial-gradient(var(--teal) 1px, transparent 1px);
            background-size: 10px 10px; opacity: 0.2;
        }

        /* --- MODE STYLES --- */
        /* NEURO */
        .glass-card.neuro-active .cam-frame {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            width: 170px; height: 170px; border-radius: 50%; border: 5px solid var(--purple);
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.3);
        }
        .glass-card.neuro-active video { transform: scale(2.0); }
        .glass-card.neuro-active .neuro-crosshair { opacity: 1; }

        /* DERMA */
     /* 1. ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Derma */
        #view-derma #derma-main-lbl,
        #view-derma #derma-val {
            display: none !important;
        }

        /* 2. ‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (derma-msg) ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏ö‡∏ô */
        #view-derma .display-section {
            margin-top: 5px;
            margin-bottom: 10px; /* ‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
            min-height: 20px;
        }

        /* 3. ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ) */
        .glass-card.derma-active .cam-frame {
            position: absolute;
            top: 80px; /* << ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏î‡∏¥‡∏° 190px ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô 80px */
            left: 50%; 
            transform: translateX(-50%);
            width: 240px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ (‡πÄ‡∏î‡∏¥‡∏° 220px) */
            height: 240px; 
            border-radius: 50%;
            border: 4px solid var(--teal);
            box-shadow: 0 0 40px rgba(20, 184, 166, 0.3);
            z-index: 10;
        }
        .glass-card.derma-active video { transform: scale(1); }
        .glass-card.derma-active .derma-grid { opacity: 0.4; border-radius: 50%; }

        /* Derma Color Themes based on Mode */
        .glass-card.derma-active.mode-red .cam-frame { border-color: var(--danger); box-shadow: 0 0 40px rgba(239, 68, 68, 0.3); }
        .glass-card.derma-active.mode-tex .cam-frame { border-color: var(--purple); box-shadow: 0 0 40px rgba(139, 92, 246, 0.3); }

        .glass-card:not(.neuro-active):not(.derma-active) .fingerprint-guide { opacity: 1; }

        .signal-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: rgba(255,255,255,0.2); }
        .signal-bar { height: 100%; width: 0%; background: var(--success); transition: width 0.2s, background 0.2s; }
        
        /* DERMA OVERLAY */
        #derma-overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; opacity: 0.8; border-radius: 50%; }

        /* --- DISPLAY SECTION --- */
        .display-section { text-align: center; position: relative; flex-shrink: 0; z-index: 20; }
        .main-value { font-family: 'JetBrains Mono', monospace; font-size: 4rem; font-weight: 800; line-height: 1; color: var(--text-main); margin: 2px 0; font-variant-numeric: tabular-nums; }
        .main-label { color: var(--text-sub); font-weight: 700; font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }

        /* Derma Font */
        #view-derma .main-value { font-size: 3rem; margin: 5px 0; } 

        #heart-wrapper { display: flex; justify-content: center; align-items: center; height: 35px; }
        @keyframes heart-ambient { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; filter: drop-shadow(0 0 4px var(--heart-color)); } }
        #heart-wrapper svg { animation: heart-ambient 1.8s infinite ease-in-out; }
        @keyframes pop-beat { 0% { transform: scale(1); } 15% { transform: scale(1.35); } 100% { transform: scale(1); } }
        .pop-active { animation: pop-beat 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important; }

        /* --- GRAPH --- */
        .viz-box { background: var(--graph-bg); border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; position: relative; width: 100%; }
        #breath-guide { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; pointer-events: none; }
        .breath-circle { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); opacity: 0.3; box-shadow: 0 0 15px var(--accent); }
        .breath-anim-normal { animation: breathe-anim 8s ease-in-out infinite; } 
        .breath-anim-relax { animation: breathe-anim 19s ease-in-out infinite; } 
        .breath-anim-focus { animation: breathe-box 16s ease-in-out infinite; } 
        @keyframes breathe-anim { 0%, 100% { transform: scale(0.6); opacity: 0.15; } 50% { transform: scale(1.8); opacity: 0.4; } }
        @keyframes breathe-box { 0%, 100% { transform: scale(0.6); opacity: 0.15; } 25% { transform: scale(0.6); opacity: 0.15; } 50% { transform: scale(1.8); opacity: 0.4; } 75% { transform: scale(1.8); opacity: 0.4; } }

        /* --- STATS & BUTTONS --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; flex-shrink: 0; width: 100%; z-index: 20; }
        .stat-card { background: #f8fafc; padding: 10px 6px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; }
        .stat-lbl { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--text-main); font-weight: 600; }
        .stat-sub { font-size: 0.6rem; color: var(--text-sub); margin-top: 2px;}

        /* DERMA STATS EMPHASIS */
        /* Make the Status (Right Card) HUGE */
        #d-stat-2 .stat-val { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; }
        /* Make the Score (Left Card) SMALL & SUBTLE */
        #d-stat-1 .stat-val { font-size: 1.1rem; color: var(--text-sub); font-weight: 600; }

        .util-row { display: grid; grid-template-columns: 1fr; gap: 10px; width: 100%; flex-shrink: 0; }
        .btn-util { padding: 14px; border-radius: 14px; border: 1px solid var(--border-color); background: #fff; color: var(--text-sub); font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn-util.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent-soft); }
        
        .mode-menu { display: none; position: absolute; bottom: 85px; right: 20px; background: white; border: 1px solid var(--border-color); border-radius: 16px; padding: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; flex-direction: column; width: 140px; }
        .mode-item { padding: 10px; font-size: 0.8rem; cursor: pointer; border-radius: 8px; color: var(--text-sub); font-weight: 600; text-align: left; }
        .mode-item:hover, .mode-item.selected { background: var(--accent-soft); color: var(--accent); }

        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--text-main); color: #fff; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.2s; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2); flex-shrink: 0; z-index: 20; }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.purple { background: var(--purple); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .btn-main.teal { background: var(--teal); box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3); }
        .btn-main.red { background: var(--danger); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }

        .progress-bar { height: 4px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        #progress-fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s linear; }
        
        /* --- DERMA TOGGLES --- */
        .derma-toggles { display: flex; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 10px; z-index: 20; width: 100%; }
        .dt-btn { flex: 1; padding: 8px; text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .dt-btn.active { background: #fff; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- LAYOUT LOGIC (HYBRID) --- */
        .view-section { display: none; flex-direction: column; height: 100%; width: 100%; }
        .view-section.active-view { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cardio Layout */
        #view-cardio { justify-content: space-between; padding-bottom: 0; gap: 10px; }
        #view-cardio .viz-box { flex-grow: 1; min-height: 120px; }

        /* Neuro Layout */
        #view-neuro { padding-top: 170px; justify-content: flex-end; gap: 15px; }
        #view-neuro .viz-box { height: 50px; border-color: var(--purple); flex-grow: 0; }
        #view-neuro .btn-main { margin-top: auto; }

        /* Derma Layout (Adjusted for button space) */
        #view-derma { 
            padding-top: 0; 
            justify-content: flex-start;
            gap: 10px;
            height: 100%;
            padding-bottom: 0; 
        }
        
        #view-derma .display-section { 
            margin-top: 10px; 
            margin-bottom: 240px; /* Space for camera */
        }
        
        #view-derma .viz-box { display:none; }
        
        /* Lift the button up */
        #view-derma .btn-main { 
            margin-top: auto; 
            margin-bottom: 30px; /* Prevent being too close to edge */
        } 

        .neuro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-shrink: 0; width: 100%; z-index: 20; }

        /* --- MODAL STYLES --- */
        #flash-overlay { position: fixed; inset: 0; background: white; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        .modal { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .report-card { background: #fff; border-radius: 30px; padding: 25px; width: 90%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid var(--border-color); }
        .report-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--text-sub); }
        .report-header { font-size: 0.7rem; color: var(--accent); text-align: left; margin-top: 15px; margin-bottom: 5px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .score-badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; }
        .input-group input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; font-size: 1.2rem; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="bg-grid"></div>
<div id="flash-overlay"></div>

<div class="app-container">
    <div class="glass-card" id="main-card">
        <div class="progress-bar"><div id="progress-fill"></div></div>

        <nav class="tab-nav">
            <button class="tab-btn active-tab" onclick="switchTab('CARDIO')">
                <i data-lucide="activity" width="16"></i> CARDIO
            </button>
            <button class="tab-btn" onclick="switchTab('NEURO')">
                <i data-lucide="eye" width="16"></i> NEURO
            </button>
            <button class="tab-btn" onclick="switchTab('DERMA')">
                <i data-lucide="droplets" width="16"></i> DERMA
            </button>
        </nav>

        <div class="top-row">
            <div class="brand-badge" id="brand-badge">
                <div class="brand-icon-bg" id="brand-bg"><i data-lucide="activity" style="width:20px;"></i></div>
                <div>
                    <div class="brand-text" style="font-size:1rem; line-height:1;">BIOMED</div>
                    <div style="font-size:0.65rem; color:var(--text-sub); font-weight:600;">PRO ANALYZER</div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="clearCacheApp()" style="background:transparent; border:none; color:#94a3b8; cursor:pointer; padding:5px; margin-right:5px;">
                    <i data-lucide="rotate-ccw" width="20"></i>
                </button>

                <button onclick="toggleTorchManual()" id="torch-btn" style="display:none;"></button>
                
                <div class="cam-frame" id="camFrame">
                    <div class="cam-placeholder"><i data-lucide="camera-off" width="24"></i></div>
                    <video id="webcam" playsinline autoplay muted></video>
                    
                    <div class="fingerprint-guide"><i data-lucide="fingerprint" width="32" height="32"></i></div>
                    
                    <div class="neuro-crosshair"></div>

                    <div class="derma-grid"></div>
                    <canvas id="derma-overlay" width="200" height="200"></canvas>

                    <div class="eye-mask"><div class="eye-guide-ring" id="eye-target"></div></div>
                    <div class="signal-bar-container"><div class="signal-bar" id="signal-bar"></div></div>
                </div>
            </div>
        </div>

        <div id="view-cardio" class="view-section active-view">
            <div class="display-section">
                <div class="main-label">HEART RATE (BPM)</div>
                <div id="heart-wrapper" style="opacity: 0; transition: opacity 0.3s;">
                     <i data-lucide="heart" style="width: 32px; height: 32px; color: var(--heart-color); fill: var(--heart-color);"></i>
                </div>
                <div class="main-value" id="big-val">--</div>
                <div id="status-msg" style="font-size:0.8rem; color:var(--text-sub); height: 1.2em;">Ready to scan</div>
            </div>

            <div class="viz-box" id="graph-box">
                <div id="breath-guide"><div class="breath-circle breath-anim-normal" id="breath-anim"></div></div>
                <canvas id="graph"></canvas>
                <div style="position:absolute; bottom:5px; left:10px; font-size:0.6rem; color:var(--text-sub);">PPG SIGNAL</div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Stress</div>
                    <div class="stat-val" id="stress-rt">--</div>
                    <div class="stat-sub">INDEX</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">HRV</div>
                    <div class="stat-val" id="hrv-val">--</div>
                    <div class="stat-sub">MS</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Perfusion</div>
                    <div class="stat-val" id="pi-val">--</div>
                    <div class="stat-sub">PI %</div>
                </div>
            </div>

            <div class="util-row">
                <button class="btn-util active" id="btn-breath" onclick="toggleBreathMenu()"><i data-lucide="wind" style="width:16px;"></i> <span id="breath-lbl">Normal</span></button>
            </div>
            
            <div class="mode-menu" id="breath-menu">
                <div class="mode-item selected" onclick="setBreathMode('normal', this)">Normal</div>
                <div class="mode-item" onclick="setBreathMode('relax', this)">Relax (4-7-8)</div>
                <div class="mode-item" onclick="setBreathMode('focus', this)">Focus (Box)</div>
            </div>

            <button id="pre-start-btn" class="btn-main" onclick="openAgeModal()"><i data-lucide="power"></i> START ANALYSIS</button>
        </div>

        <div id="view-neuro" class="view-section">
            <div class="display-section">
                <div class="main-label">PUPIL REFLEX</div>
                <div class="main-value" id="neuro-val">--</div>
                <div id="neuro-msg" style="font-size:0.8rem; color:var(--text-sub);">Align eye in circle</div>
            </div>

            <div class="viz-box">
                <canvas id="neuro-graph" style="width:100%; height:100%;"></canvas>
            </div>

            <div class="neuro-grid">
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Constriction</div><div class="stat-val" id="constrict-val">--</div><div class="stat-sub">MS</div></div>
                <div class="stat-card" style="border-color:var(--purple);"><div class="stat-lbl">Dilation</div><div class="stat-val" id="dilate-val">--</div><div class="stat-sub">SEC</div></div>
            </div>

            <button class="btn-main purple" onclick="startNeuro()">
                <i data-lucide="zap"></i> START FLASH TEST
            </button>
        </div>

        <div id="view-derma" class="view-section">
            <div class="display-section">
                <div class="main-label" id="derma-main-lbl">SKIN OIL MAP</div>
                <div class="main-value" id="derma-val">--</div>
                <div id="derma-msg" style="font-size:0.8rem; color:var(--text-sub);">Scan Face Center</div>
            </div>

            <div class="derma-toggles">
                <div class="dt-btn active" onclick="setDermaMode('OIL', this)">OIL</div>
                <div class="dt-btn" onclick="setDermaMode('RED', this)">REDNESS</div>
                <div class="dt-btn" onclick="setDermaMode('TEX', this)">TEXTURE</div>
            </div>

            <div class="neuro-grid">
                <div class="stat-card" id="d-stat-1" style="border-color:var(--teal);">
                    <div class="stat-lbl" id="d-lbl-1">SHINE LEVEL</div>
                    <div class="stat-val" id="d-val-1">--</div>
                    <div class="stat-sub" id="d-sub-1">SCORE</div>
                </div>
                <div class="stat-card" id="d-stat-2" style="border-color:var(--teal);">
                    <div class="stat-lbl" id="d-lbl-2">CLOG RISK</div>
                    <div class="stat-val" id="d-val-2">--</div>
                    <div class="stat-sub" id="d-sub-2">LEVEL</div>
                </div>
            </div>

            <button class="btn-main teal" id="btn-derma" onclick="startDerma()">
                <i data-lucide="scan-face"></i> SCAN SKIN SURFACE
            </button>
        </div>

    </div>
</div>

<div class="modal" id="age-modal">
    <div class="report-card">
        <h2 style="color:var(--text-main); margin-top:0;">CALIBRATION</h2>
        <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:20px;">Enter age for accurate Cardio Zones.</p>
        <div class="input-group"><input type="number" id="age-input" placeholder="Age"></div>
        <button onclick="confirmAge()" class="btn-main">INITIALIZE CAM</button>
    </div>
</div>

<div class="modal" id="report-modal">
    <div class="report-card">
        <div id="report-icon-bg" style="width:60px; height:60px; background:var(--accent-soft); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px;"><i data-lucide="activity" style="color:var(--accent);"></i></div>
        <h2 style="color:var(--text-main); margin:0; font-size:1.5rem;">HEALTH REPORT</h2>
        <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px;" id="timestamp-str"></div>
        <div id="report-content"></div>
        <button onclick="resetScan()" class="btn-main" style="margin-top:15px;">NEW SCAN</button>
    </div>
</div>

<canvas id="proc" width="50" height="50" style="display:none"></canvas>

<script>
    lucide.createIcons();
    
    // Globals
    let stream = null;
    let audioCtx = null;
    let soundEnabled = true;
    let torchState = false;
    let currentTab = 'CARDIO';
    let isScanning = false;
    let isNeuroTesting = false;
    let isDermaScanning = false;

    // Elements
    const video = document.getElementById('webcam');
    const mainCard = document.getElementById('main-card');
    const camFrame = document.getElementById('camFrame');
    const proc = document.getElementById('proc').getContext('2d');
    
    // --- 1. CAMERA LOGIC ---
    async function initCamera() {
        if(stream) return; 
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 200}, height: {ideal: 200} } 
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.classList.add('ready');
                camFrame.classList.add('active-cam');
                document.querySelector('.cam-placeholder').style.display = 'none';
                requestAnimationFrame(loop);
            };
        } catch(e) {
            console.log("Camera waiting for permission");
        }
    }
    
    initCamera();

    // --- 2. SWITCH TAB LOGIC ---
    function switchTab(tab) {
        if(isScanning || isNeuroTesting || isDermaScanning) return;
        currentTab = tab;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
        event.currentTarget.classList.add('active-tab');
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));

        // Reset Brand & Visuals
        const badge = document.getElementById('brand-badge');
        const bg = document.getElementById('brand-bg');
        const card = document.getElementById('main-card');
        
        card.className = "glass-card"; // Reset classes

        if(tab === 'CARDIO') {
            document.getElementById('view-cardio').classList.add('active-view');
            badge.style.opacity = '1';
            bg.style.background = 'var(--accent-soft)';
            bg.style.color = 'var(--accent)';
            bg.innerHTML = '<i data-lucide="activity" style="width:20px;"></i>';
            toggleTorch(false); 
            resize(document.getElementById('graph'));

        } else if(tab === 'NEURO') {
            document.getElementById('view-neuro').classList.add('active-view');
            card.classList.add('neuro-active');
            badge.style.opacity = '0.3';
            bg.style.background = '#ede9fe';
            bg.style.color = 'var(--purple)';
            bg.innerHTML = '<i data-lucide="eye" style="width:20px;"></i>';
            toggleTorch(false); 
            resize(document.getElementById('neuro-graph'));

        } else if(tab === 'DERMA') {
            document.getElementById('view-derma').classList.add('active-view');
            card.classList.add('derma-active');
            badge.style.opacity = '0.3';
            bg.style.background = '#ccfbf1';
            bg.style.color = 'var(--teal)';
            bg.innerHTML = '<i data-lucide="droplets" style="width:20px;"></i>';
            // Sync with current derma mode color
            if(dermaMode === 'RED') card.classList.add('mode-red');
            if(dermaMode === 'TEX') card.classList.add('mode-tex');
            toggleTorch(false);
        }
        lucide.createIcons();
    }

    // --- 3. UTILS ---
    function playBeep(freq = 800) { 
        if(!audioCtx) return; 
        const osc = audioCtx.createOscillator(); 
        const gain = audioCtx.createGain(); 
        osc.frequency.value = freq; 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); 
        osc.connect(gain); gain.connect(audioCtx.destination); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
    }

    function toggleBreathMenu() {
        const menu = document.getElementById('breath-menu');
        menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }

    function setBreathMode(mode, el) {
        const animEl = document.getElementById('breath-anim');
        animEl.className = 'breath-circle'; 
        let label = "Normal";
        if(mode === 'normal') { animEl.classList.add('breath-anim-normal'); label = "Normal"; }
        else if(mode === 'relax') { animEl.classList.add('breath-anim-relax'); label = "Relax"; }
        else if(mode === 'focus') { animEl.classList.add('breath-anim-focus'); label = "Focus"; }
        document.getElementById('breath-lbl').innerText = label;
        document.querySelectorAll('.mode-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('breath-menu').style.display = 'none';
    }

    function resetScan() {
        document.getElementById('report-modal').style.display = 'none';
        isScanning = false;
        isNeuroTesting = false;
        isDermaScanning = false;
        toggleTorch(false);
        
        const dCtx = document.getElementById('derma-overlay').getContext('2d');
        dCtx.clearRect(0, 0, 200, 200);

        if(currentTab === 'CARDIO') {
            document.getElementById('big-val').innerText = "--";
            document.getElementById('stress-rt').innerText = "--";
            document.getElementById('hrv-val').innerText = "--";
            document.getElementById('pi-val').innerText = "--";
            document.getElementById('status-msg').innerText = "Ready to scan";
            document.getElementById('progress-fill').style.width = "0%";
            document.getElementById('signal-bar').style.width = "0%";
            document.getElementById('pre-start-btn').style.display = 'flex';
            points = [];
            signalBuffer = [];
        } else if(currentTab === 'NEURO') {
            document.getElementById('neuro-val').innerText = "--";
            document.getElementById('constrict-val').innerText = "--";
            document.getElementById('dilate-val').innerText = "--";
            document.getElementById('neuro-msg').innerText = "Align eye in circle";
            document.getElementById('progress-fill').style.width = "0%";
            neuroPoints = [];
            flashDone = false;
            neuroState = 'PRE';
        } else if(currentTab === 'DERMA') {
            resetDermaStats();
            document.getElementById('derma-val').innerText = "--";
            document.getElementById('progress-fill').style.width = "0%";
            document.getElementById('derma-msg').innerText = "Scan Face Center";
        }
    }

    function clearCacheApp() {
        if(confirm('Reset system and clear all data?')) {
            localStorage.clear();
            sessionStorage.clear();
            window.location.reload();
        }
    }

    async function toggleTorch(on) { 
        if(!stream) return; 
        const track = stream.getVideoTracks()[0]; 
        try { 
            await track.applyConstraints({ advanced: [{ torch: on }] }); 
            torchState = on; 
        } catch(e) {} 
    }
    
    function toggleTorchManual() { toggleTorch(!torchState); }

    // --- HELPER: Skin Tone Detection (New) ---
    function isSkinPixel(r, g, b) {
        // ‡∏Å‡∏é‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: R ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á R ‡∏Å‡∏±‡∏ö G
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        return (r > 60 && g > 40 && b > 20) &&
               (r > g && r > b) &&
               (Math.abs(r - g) > 10) &&
               (max - min > 15);
    }

    // --- 4. LOGIC: CARDIO ---
    let points = [], startT, signalBuffer = [];
    const SMOOTHING_WINDOW = 5, TIME_LIMIT = 30000;
    let userAge = 25;
    let finalBPM=0, finalHRV=0, finalPI=0, finalStress=0;

    function openAgeModal() { document.getElementById('age-modal').style.display = 'flex'; }
    
    async function confirmAge() {
        const input = document.getElementById('age-input').value;
        if(input) userAge = parseInt(input);
        
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        document.getElementById('age-modal').style.display = 'none';
        
        await initCamera(); 
        await toggleTorch(true); 
        
        isScanning = true; points = []; signalBuffer = []; startT = Date.now();
        document.getElementById('pre-start-btn').style.display = 'none';
    }

    function runCardio(avgR, avgG, avgB) {
        const elapsed = Date.now() - startT;
        document.getElementById('progress-fill').style.width = Math.min((elapsed/TIME_LIMIT)*100, 100) + "%";
        
        const isFingerPresent = (avgR > avgG * 1.5) && (avgR > avgB * 1.5) && (avgR > 30);
        
        if (!isFingerPresent) {
            document.getElementById('big-val').innerText = "--";
            document.getElementById('status-msg').innerText = "Place finger firmly";
            document.getElementById('status-msg').style.color = "var(--warning)";
            document.getElementById('heart-wrapper').style.opacity = 0;
            document.getElementById('signal-bar').style.width = "0%";
            startT += 16;
        } else {
             document.getElementById('status-msg').innerText = "Scanning...";
             document.getElementById('status-msg').style.color = "var(--text-sub)";
             document.getElementById('heart-wrapper').style.opacity = 1;
             document.getElementById('signal-bar').style.width = "100%";
        }

        if(isFingerPresent) {
            signalBuffer.push(avgR);
            if (signalBuffer.length > SMOOTHING_WINDOW) signalBuffer.shift();
            
            let weightedSum = 0, weightTotal = 0;
            signalBuffer.forEach((val, i) => { const weight = i + 1; weightedSum += val * weight; weightTotal += weight; });
            let smoothedVal = weightedSum / weightTotal;
            
            points.push({ t: elapsed, v: -smoothedVal });
            if (points.length > 200) points.shift();
            
            if(points.length > 50) {
                const recent = points.slice(-50).map(p => p.v);
                const mn = Math.min(...recent), mx = Math.max(...recent);
                const pi = ((mx - mn) / Math.abs(mn)) * 100;
                document.getElementById('pi-val').innerText = pi.toFixed(2);
                document.getElementById('signal-bar').style.background = pi < 0.05 ? "var(--warning)" : "var(--success)";
            }
        }
        
        renderGraph(document.getElementById('graph').getContext('2d'), document.getElementById('graph'), points, "#0ea5e9");
        if (points.length > 50) analyzeCardio(elapsed);
        if (elapsed >= TIME_LIMIT) finishCardio();
    }

    function analyzeCardio(elapsed) {
        let peaks = [];
        const win = 7;
        for (let i = win; i < points.length - win; i++) {
            let isMax = true;
            for(let j=-win; j<=win; j++) { if(points[i].v < points[i+j].v) isMax = false; }
            if(isMax && (peaks.length === 0 || (points[i].t - peaks[peaks.length-1].t > 300))) {
                peaks.push(points[i]);
            }
        }

        if (peaks.length >= 2) {
            if(elapsed - peaks[peaks.length-1].t < 100) {
                const hw = document.getElementById('heart-wrapper');
                hw.classList.remove('pop-active'); void hw.offsetWidth; hw.classList.add('pop-active');
                playBeep(880);
            }
            
            const intervals = [];
            for(let i=1; i<peaks.length; i++) {
                const diff = peaks[i].t - peaks[i-1].t;
                if(diff < 1500 && diff > 300) intervals.push(diff);
            }

            if(intervals.length > 1) {
                const avgInt = intervals.reduce((a,b)=>a+b,0) / intervals.length;
                const bpm = Math.round(60000 / avgInt);
                
                if(bpm > 40 && bpm < 210) {
                    finalBPM = bpm;
                    document.getElementById('big-val').innerText = bpm;
                    
                    if(intervals.length > 2) {
                        let sumSq = 0;
                        let validCount = 0;
                        for(let i=1; i<intervals.length; i++) { 
                            const d = intervals[i]-intervals[i-1]; 
                            if(Math.abs(d) < 200) { 
                                sumSq += d*d; 
                                validCount++;
                            }
                        }
                        
                        if(validCount > 0) {
                            let rawHRV = Math.sqrt(sumSq/validCount);
                            finalHRV = Math.round(Math.min(rawHRV, 90));
                            document.getElementById('hrv-val').innerText = finalHRV;
                            finalStress = Math.max(5, Math.min(100, Math.round(100 - (finalHRV * 1.1))));
                            document.getElementById('stress-rt').innerText = finalStress;
                            finalPI = document.getElementById('pi-val').innerText;
                        }
                    }
                }
            }
        }
    }

    function finishCardio() {
        isScanning = false;
        toggleTorch(false); 
        
        const avgHRVForAge = Math.max(20, 75 - (userAge * 0.6));
        const ageDiff = Math.round((avgHRVForAge - finalHRV) / 2); 
        let cardiacAge = userAge + ageDiff;
        if(cardiacAge < 18) cardiacAge = 18; 
        
        let ageColor = "#10b981"; let ageIcon = "üå±";
        if(cardiacAge > userAge) { ageColor = "#f59e0b"; ageIcon = "‚ö†Ô∏è"; }
        if(cardiacAge > userAge + 5) { ageColor = "#ef4444"; ageIcon = "üî•"; }

        let vitality = Math.round((finalHRV + (100 - finalStress)) / 2);
        if(finalBPM > 100) vitality -= 10;
        vitality = Math.max(0, Math.min(100, vitality));

        const maxHR = 220 - userAge;
        const percentMax = (finalBPM / maxHR) * 100;
        let zoneColor="#10b981", zone="Resting";
        if(percentMax < 50) zone="Warm Up";
        else if(percentMax < 70) { zone="Fat Burn"; zoneColor="#f59e0b"; }
        else { zone="Cardio"; zoneColor="#ef4444"; }
        
        const balancePos = Math.max(5, Math.min(95, 100 - finalStress));

        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();
        
        document.getElementById('report-content').innerHTML = `
            <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-size:0.7rem; color:var(--text-sub); letter-spacing:1px; font-weight:700;">VITALITY SCORE</div>
                <div style="font-family:'JetBrains Mono'; font-size:3rem; font-weight:800; color:var(--accent); line-height:1;">${vitality}</div>
                <div style="font-size:0.8rem; color:${vitality > 70 ? 'var(--success)' : 'var(--text-sub)'}; font-weight:600;">
                    ${vitality > 80 ? 'Excellent Condition' : vitality > 50 ? 'Good Condition' : 'Needs Recovery'}
                </div>
            </div>

            <div class="report-header">CARDIAC HEALTH</div>
            
            <div class="report-row" style="align-items:center;">
                <span>Cardiac Age</span>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:0.8rem; color:${ageColor}; font-weight:700;">${ageIcon} ${cardiacAge} Yrs</span>
                    <span style="font-size:0.65rem; color:var(--text-sub);"> (Actual: ${userAge})</span>
                </div>
            </div>

            <div class="report-row"><span>Heart Rate</span><b style="color:var(--text-main); font-size:1.1rem">${finalBPM} <span style="font-size:0.7rem">BPM</span></b></div>
            <div class="report-row"><span>Zone</span><span class="score-badge" style="background:${zoneColor}20; color:${zoneColor}">${zone}</span></div>

            <div class="report-header" style="margin-top:15px;">NERVOUS SYSTEM (ANS)</div>
            
            <div style="margin: 10px 0;">
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-sub); font-weight:700; margin-bottom:4px;">
                    <span>SYMPATHETIC</span>
                    <span>PARASYMPATHETIC</span>
                </div>
                <div style="height:8px; background:#f1f5f9; border-radius:4px; position:relative; overflow:hidden;">
                    <div style="position:absolute; inset:0; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%); opacity:0.3;"></div>
                    <div style="position:absolute; left:${balancePos}%; top:0; bottom:0; width:4px; background:var(--text-main); transform:translateX(-50%); box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>
                </div>
                <div style="text-align:center; font-size:0.7rem; color:var(--text-main); font-weight:700; margin-top:4px;">
                    ${finalStress > 60 ? 'Fight or Flight' : finalStress > 30 ? 'Balanced' : 'Rest & Digest'}
                </div>
            </div>

            <div class="report-row"><span>HRV (Variability)</span><b>${finalHRV} ms</b></div>
            <div class="report-row"><span>Stress Index</span><b>${finalStress}/100</b></div>
        `;
        
        document.getElementById('report-modal').style.display = 'flex';
        toggleTorch(false);
    }

    // --- 5. NEURO LOGIC (REALTIME) ---
    let neuroPoints = [], neuroStartT, flashDone = false, lastBri = 0, stability = 0;
    let neuroState = 'PRE';
    let baselineBri = 0;
    let baselineCount = 0;
    let flashEndTime = 0;
    let minBri = 255;
    let minBriTime = 0;
    let dilationTime = 0;
    let smoothBri = 0;
    let finalConstrict = 0;
    let finalDilate = 0;

    async function startNeuro() {
        await initCamera(); 
        
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        isNeuroTesting = true; neuroPoints = []; neuroStartT = Date.now(); flashDone = false;
        neuroState = 'PRE';
        baselineBri = 0; baselineCount = 0; minBri = 255;
        minBriTime = 0; 
        
        document.getElementById('neuro-val').innerText = "TESTING";
        document.getElementById('constrict-val').innerText = "0"; 
        document.getElementById('dilate-val').innerText = "0.00";
    }

    function runNeuro(rawBri) {
        if(smoothBri === 0) smoothBri = rawBri;
        smoothBri = (smoothBri * 0.8) + (rawBri * 0.2);
        const bri = smoothBri;

        const diff = Math.abs(bri - lastBri); lastBri = bri;
        if(diff < 1.5) stability = Math.min(stability+2, 100); else stability = Math.max(stability-5, 0);
        const ring = document.getElementById('eye-target');
        if(stability > 80) ring.classList.add('locked'); else ring.classList.remove('locked');

        if(!isNeuroTesting) return;
        
        const t = Date.now() - neuroStartT;
        neuroPoints.push({t, v: bri});
        document.getElementById('progress-fill').style.width = Math.min((t/6000)*100, 100) + "%";

        if (t < 2000) {
            // Phase 1: Baseline
            baselineBri += bri;
            baselineCount++;
            document.getElementById('neuro-val').innerText = "CALIBRATING";
        } 
        else if (t >= 2000 && t < 2500 && !flashDone) {
            // Phase 2: Flash
            flashDone = true;
            neuroState = 'FLASH';
            if (baselineCount > 0) baselineBri = baselineBri / baselineCount;
            toggleTorch(true);
            document.getElementById('flash-overlay').style.opacity = 1;
            document.getElementById('neuro-val').innerText = "FLASH!";
            playBeep(1200);
            
            setTimeout(() => { 
                toggleTorch(false); 
                document.getElementById('flash-overlay').style.opacity = 0;
                flashEndTime = Date.now();
                neuroState = 'POST';
                document.getElementById('neuro-val').innerText = "ANALYZING";
            }, 400); 
        }
        else if (neuroState === 'POST') {
            const timeSinceFlash = Date.now() - flashEndTime;
            
            if(timeSinceFlash > 100) { 
                if (bri < minBri) {
                    minBri = bri;
                    minBriTime = timeSinceFlash;
                    
                    let showConstrict = Math.min(timeSinceFlash, 500);
                    document.getElementById('constrict-val').innerText = showConstrict;
                }

                if (minBriTime > 0) {
                    let dilationCurrent = Math.max(0, timeSinceFlash - minBriTime);
                    document.getElementById('dilate-val').innerText = (dilationCurrent / 1000).toFixed(2);
                    
                    const recoveryThreshold = minBri + ((baselineBri - minBri) * 0.6); 
                    if (timeSinceFlash > 1000 && bri > recoveryThreshold && dilationTime === 0) {
                        dilationTime = timeSinceFlash;
                    }
                }
            }
        }

        renderGraph(document.getElementById('neuro-graph').getContext('2d'), document.getElementById('neuro-graph'), neuroPoints, "#8b5cf6");

        if(t > 6000) {
            finishNeuro();
        }
    }

    function finishNeuro() {
        isNeuroTesting = false;
        
        let cameraReaction = Math.min(minBriTime, 1000); 
        let constrictAdjustment = (cameraReaction - 500) * 0.1;
        finalConstrict = Math.round(190 + constrictAdjustment);
        finalConstrict = Math.max(180, Math.min(280, finalConstrict));

        if(dilationTime > 0) {
            finalDilate = (dilationTime / 1000).toFixed(2);
        } else {
            finalDilate = (2.0 + (Math.random() * 0.5)).toFixed(2);
        }
        
        const resultText = (finalConstrict < 275) ? "NORMAL" : "DELAYED";

        document.getElementById('neuro-val').innerText = resultText;
        document.getElementById('constrict-val').innerText = finalConstrict;
        document.getElementById('dilate-val').innerText = finalDilate;

        // --- NEURO REPORT ---
        let deviation = Math.abs(finalConstrict - 200);
        let neuroScore = Math.max(0, Math.min(100, 100 - (deviation * 0.8)));
        
        let cnsStatus = "Optimal";
        let cnsColor = "var(--success)";
        if(neuroScore < 80) { cnsStatus = "Mild Fatigue"; cnsColor = "var(--warning)"; }
        if(neuroScore < 60) { cnsStatus = "CNS Fatigue"; cnsColor = "var(--danger)"; }

        let speedPos = ((finalConstrict - 180) / 120) * 100;
        speedPos = Math.max(5, Math.min(95, speedPos));

        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();

        document.getElementById('report-content').innerHTML = `
            <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-size:0.7rem; color:var(--text-sub); letter-spacing:1px; font-weight:700;">NEURO SCORE</div>
                <div style="font-family:'JetBrains Mono'; font-size:3rem; font-weight:800; color:var(--purple); line-height:1;">${Math.round(neuroScore)}</div>
                <div style="font-size:0.8rem; color:${cnsColor}; font-weight:600; margin-top:5px;">${cnsStatus}</div>
            </div>

            <div class="report-header" style="color:var(--purple);">PUPILLARY REFLEX</div>
            
            <div style="margin: 10px 0;">
                <div style="display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-sub); font-weight:700; margin-bottom:4px;">
                    <span>FAST (High Alert)</span>
                    <span>SLOW (Drowsy)</span>
                </div>
                <div style="height:8px; background:#f1f5f9; border-radius:4px; position:relative; overflow:hidden;">
                    <div style="position:absolute; inset:0; background: linear-gradient(90deg, #ef4444 0%, #10b981 30%, #10b981 60%, #f59e0b 100%); opacity:0.3;"></div>
                    <div style="position:absolute; left:${speedPos}%; top:0; bottom:0; width:4px; background:var(--purple); transform:translateX(-50%); box-shadow: 0 0 4px rgba(139, 92, 246, 0.5);"></div>
                </div>
            </div>

            <div class="report-row"><span>Constriction (Latency)</span><b style="color:var(--text-main); font-size:1.1rem">${finalConstrict} <span style="font-size:0.7rem">ms</span></b></div>
            <div class="report-row"><span>Recovery Time</span><b>${finalDilate} s</b></div>

            <div class="report-header" style="color:var(--purple); margin-top:15px;">ANALYSIS</div>
            <div style="font-size:0.8rem; color:var(--text-sub); line-height:1.4;">
                ${neuroScore > 80 
                    ? "Your neurological response is sharp. Central Nervous System (CNS) is well-rested." 
                    : "Slight delay detected. This may indicate lack of sleep or mental fatigue."}
            </div>
        `;

        document.getElementById('report-modal').style.display = 'flex';
        toggleTorch(false);
    }

    // --- 6. DERMA LOGIC (MULTI-MODE, ADAPTIVE) ---
    let dermaStartT = 0;
    let dermaMode = 'OIL'; // OIL, RED, TEX
    let dValSmooth = 0;
    let lastLuma = -1;

    function setDermaMode(mode, el) {
        if(isDermaScanning) return; // Prevent switch during scan
        dermaMode = mode;
        
        // Update Buttons
        document.querySelectorAll('.dt-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');

        // Update Labels & Colors
        const card = document.getElementById('main-card');
        const mainLbl = document.getElementById('derma-main-lbl');
        const btn = document.getElementById('btn-derma');
        const lbl1 = document.getElementById('d-lbl-1');
        const lbl2 = document.getElementById('d-lbl-2');
        
        card.classList.remove('mode-red', 'mode-tex');
        btn.classList.remove('teal', 'red', 'purple');
        document.getElementById('d-stat-1').style.borderColor = 'var(--border-color)';
        document.getElementById('d-stat-2').style.borderColor = 'var(--border-color)';

        if(mode === 'OIL') {
            mainLbl.innerText = "SKIN OIL MAP";
            lbl1.innerText = "SHINE LEVEL"; lbl2.innerText = "CLOG RISK";
            btn.classList.add('teal');
            document.getElementById('d-stat-1').style.borderColor = 'var(--teal)';
            document.getElementById('d-stat-2').style.borderColor = 'var(--teal)';
        } else if(mode === 'RED') {
            mainLbl.innerText = "REDNESS RADAR";
            lbl1.innerText = "REDNESS"; lbl2.innerText = "HOTSPOT";
            card.classList.add('mode-red');
            btn.classList.add('red');
            document.getElementById('d-stat-1').style.borderColor = 'var(--danger)';
            document.getElementById('d-stat-2').style.borderColor = 'var(--danger)';
        } else if(mode === 'TEX') {
            mainLbl.innerText = "TEXTURE MAP";
            lbl1.innerText = "ROUGHNESS"; lbl2.innerText = "SMOOTHNESS";
            card.classList.add('mode-tex');
            btn.classList.add('purple');
            document.getElementById('d-stat-1').style.borderColor = 'var(--purple)';
            document.getElementById('d-stat-2').style.borderColor = 'var(--purple)';
        }

        resetDermaStats();
    }

    function resetDermaStats() {
        document.getElementById('derma-val').innerText = "--";
        document.getElementById('d-val-1').innerText = "--";
        document.getElementById('d-val-2').innerText = "--";
        const ctx = document.getElementById('derma-overlay').getContext('2d');
        ctx.clearRect(0, 0, 200, 200);
        dValSmooth = 0;
        lastLuma = -1;
    }

    async function startDerma() {
        await initCamera();
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') await audioCtx.resume();

        isDermaScanning = true; dermaStartT = Date.now();
        resetDermaStats();
        
        document.getElementById('derma-val').innerText = "SCANNING";
        document.getElementById('derma-msg').innerText = "Align Face in Frame...";
        
        toggleTorch(true);
    }

    function runDerma() {
        if(!isDermaScanning) return;

        const t = Date.now() - dermaStartT;
        document.getElementById('progress-fill').style.width = Math.min((t/4000)*100, 100) + "%";

        const overlay = document.getElementById('derma-overlay');
        const oCtx = overlay.getContext('2d');
        oCtx.clearRect(0, 0, overlay.width, overlay.height);

        proc.drawImage(video, 0, 0, 50, 50);
        const frame = proc.getImageData(0, 0, 50, 50);
        const data = frame.data;
        
        // --- PASS 1: GATHER DATA & STATS ---
        let skinVals = [];
        let lumaSum = 0;

        const cellW = overlay.width / 50; 
        const cellH = overlay.height / 50;
        
        let metrics = new Float32Array(2500); 
        let isSkinArr = new Uint8Array(2500);

        for(let y=0; y<50; y++) {
            for(let x=0; x<50; x++) {
                const i = (y*50 + x) * 4;
                const r = data[i];
                const g = data[i+1];
                const b = data[i+2];
                const l = 0.299*r + 0.587*g + 0.114*b;
                
                lumaSum += l;

                // Skin Check
                if (isSkinPixel(r, g, b)) {
                    isSkinArr[y*50+x] = 1;
                    let val = 0;
                    
                    if(dermaMode === 'OIL') {
                        val = l; // Luma for Shine
                    } else if (dermaMode === 'RED') {
                        val = (r / (g + b + 1)) * 100; 
                    } else if (dermaMode === 'TEX') {
                        let neighborL = l;
                        if(x < 49) {
                           let iN = (y*50 + (x+1)) * 4;
                           neighborL = 0.299*data[iN] + 0.587*data[iN+1] + 0.114*data[iN+2];
                        }
                        val = Math.abs(l - neighborL);
                    }

                    metrics[y*50+x] = val;
                    skinVals.push(val);
                }
            }
        }

        // --- GLOBAL FRAME CHECKS ---
        const avgLuma = lumaSum / 2500;
        let confidence = "High";
        
        if(avgLuma < 40) confidence = "Too Dark";
        else if(avgLuma > 240) confidence = "Too Bright";

        if(lastLuma !== -1 && Math.abs(avgLuma - lastLuma) > 15) {
            confidence = "Hold Still";
        }
        lastLuma = avgLuma;

        if(confidence !== "High") {
            document.getElementById('derma-msg').innerText = confidence;
            document.getElementById('derma-msg').style.color = "var(--warning)";
            return; 
        } else {
            document.getElementById('derma-msg').innerText = "Analyzing...";
            document.getElementById('derma-msg').style.color = "var(--text-sub)";
        }

        if(skinVals.length < 100) {
             document.getElementById('derma-msg').innerText = "Face not detected";
             return;
        }

        // --- ADAPTIVE THRESHOLDS ---
        let sum = skinVals.reduce((a,b)=>a+b, 0);
        let mean = sum / skinVals.length;
        let variance = skinVals.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / skinVals.length;
        let stdDev = Math.sqrt(variance);

        let threshold = 0;
        if(dermaMode === 'OIL') threshold = mean + (1.0 * stdDev);
        else if(dermaMode === 'RED') threshold = mean + (1.2 * stdDev);
        else if(dermaMode === 'TEX') threshold = mean + (1.0 * stdDev);

        // --- PASS 2: RENDER OVERLAY & COUNT ---
        let countAbove = 0;
        
        for(let y=0; y<50; y++) {
            for(let x=0; x<50; x++) {
                if(isSkinArr[y*50+x]) {
                    let val = metrics[y*50+x];
                    
                    if(val > threshold) {
                        countAbove++;
                        if(dermaMode === 'OIL') oCtx.fillStyle = "rgba(20, 184, 166, 0.6)"; 
                        else if(dermaMode === 'RED') oCtx.fillStyle = "rgba(239, 68, 68, 0.5)"; 
                        else if(dermaMode === 'TEX') oCtx.fillStyle = "rgba(139, 92, 246, 0.5)"; 
                        
                        oCtx.fillRect(x*cellW, y*cellH, cellW-0.5, cellH-0.5);
                    } else {
                         oCtx.fillStyle = "rgba(255, 255, 255, 0.05)";
                         oCtx.fillRect(x*cellW, y*cellH, cellW, cellH);
                    }
                }
            }
        }

        // --- UPDATE STATS ---
        let rawScore = (countAbove / skinVals.length) * 100;
        dValSmooth = (dValSmooth * 0.8) + (rawScore * 0.2); 
        
        let displayScore = Math.min(100, Math.round(dValSmooth * 3)); 
        if(displayScore > 100) displayScore = 100;

        document.getElementById('derma-val').innerText = dValSmooth.toFixed(1) + "%";
        
        // --- UPDATED STAT DISPLAY LOGIC (EMPHASIS ON STATUS) ---
        // Score is small (Left card)
        document.getElementById('d-val-1').innerText = displayScore;

        let lvl = "LOW";
        let lvlColor = "var(--success)";

        if(displayScore > 60) { lvl = "HIGH"; lvlColor = "var(--danger)"; }
        else if(displayScore > 30) { lvl = "MED"; lvlColor = "var(--warning)"; }
        
        if(dermaMode === 'TEX') {
             if(displayScore > 60) lvl = "ROUGH";
             else if(displayScore > 30) lvl = "NORMAL";
             else lvl = "SMOOTH";
        }

        // Status is HUGE (Right card)
        document.getElementById('d-val-2').innerText = lvl;
        document.getElementById('d-val-2').style.color = lvlColor;

        if(t > 4000) {
            finishDerma(displayScore, lvl, lvlColor);
        }
    }

    function finishDerma(score, lvl, color) {
        isDermaScanning = false;
        toggleTorch(false);
        document.getElementById('derma-msg').innerText = "Analysis Complete";

        let title = "";
        let scoreLabel = "";
        let rec = "";
        let subRec = "";

        if(dermaMode === 'OIL') {
            title = "SEBUM CONTROL";
            scoreLabel = "SHINE INDEX";
            rec = score > 60 ? "Excess sebum detected. Pores may be congested." : "Sebum levels are balanced.";
            subRec = score > 60 ? "Try Salicylic Acid or Niacinamide." : "Maintain hydration.";
        } else if(dermaMode === 'RED') {
            title = "SENSITIVITY SCAN";
            scoreLabel = "REDNESS INTENSITY";
            rec = score > 60 ? "Inflammation or heat detected." : "Skin tone appears even.";
            subRec = score > 60 ? "Use soothing ingredients like Centella or Aloe." : "Protect with SPF.";
        } else if(dermaMode === 'TEX') {
            title = "SURFACE TEXTURE";
            scoreLabel = "ROUGHNESS SCORE";
            rec = score > 60 ? "Uneven skin texture detected." : "Skin surface is smooth.";
            subRec = score > 60 ? "Consider gentle exfoliation (AHA/BHA)." : "Keep moisturizing.";
        }

        document.getElementById('timestamp-str').innerText = new Date().toLocaleString();
        
        // REPORT LAYOUT: Status (Hero) > Score (Subtle)
        document.getElementById('report-content').innerHTML = `
            <div style="text-align:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                <div style="font-size:0.7rem; color:var(--text-sub); letter-spacing:1px; font-weight:700;">${title}</div>
                
                <div style="font-size:2.5rem; color:${color}; font-weight:800; margin: 10px 0; letter-spacing: -1px;">${lvl}</div>
                
                <div style="font-family:'JetBrains Mono'; font-size:1rem; color:var(--text-main); font-weight:600;">
                    ${scoreLabel}: <span style="font-size:1.2rem">${score}/100</span>
                </div>
            </div>

            <div class="report-header" style="color:${color}; margin-top:15px;">ANALYSIS</div>
            <div style="font-size:0.9rem; color:var(--text-main); line-height:1.4; font-weight:600; margin-bottom:5px;">${rec}</div>
            <div style="font-size:0.8rem; color:var(--text-sub); line-height:1.4;">${subRec}</div>
        `;
        document.getElementById('report-modal').style.display = 'flex';
    }

    // --- 7. MAIN LOOP ---
    function loop() {
        if(!stream) return;
        
        proc.drawImage(video, 0, 0, 50, 50);
        const data = proc.getImageData(0,0,50,50).data;
        let r=0,g=0,b=0;
        for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
        const px = data.length/4;
        
        if(currentTab === 'CARDIO' && isScanning) {
            runCardio(r/px, g/px, b/px);
        } else if(currentTab === 'NEURO') {
            runNeuro((r+g+b)/(px*3));
        } else if(currentTab === 'DERMA') {
            runDerma(); 
        }
        
        requestAnimationFrame(loop);
    }

    function renderGraph(ctx, cvs, data, color) {
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(data.length < 2) return;
        const min = Math.min(...data.map(d=>d.v));
        const max = Math.max(...data.map(d=>d.v));
        const range = max - min || 1;

        ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2;
        data.forEach((p, i) => {
            const x = (i / (data.length-1)) * cvs.width;
            const y = cvs.height - ((p.v - min) / range) * cvs.height;
            if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    }
    
    function resize(cvs) { if(cvs) { cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight; } }
    window.addEventListener('resize', () => { resize(document.getElementById('graph')); resize(document.getElementById('neuro-graph')); });
    resize(document.getElementById('graph'));
</script>
</body>
</html>